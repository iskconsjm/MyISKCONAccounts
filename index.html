<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Temple Donation Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <!-- MyISKCON Accounts - Production SDK -->
  <script>
    // ==================== CONFIGURATION ====================
    // Google Apps Script Web App URL
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyVAuEfk2a6Lepa6AyAZfItEyzs2VSnwFhI3qMFeGX9cwApXDEcoyxF1rTO2PN4CKwv/exec';
    
    // Session storage key
    const SESSION_KEY = 'myiskcon_session';
    
    // ==================== SESSION MANAGEMENT ====================
    const sessionManager = {
      getSession: function() {
        const session = localStorage.getItem(SESSION_KEY);
        return session ? JSON.parse(session) : null;
      },
      
      setSession: function(sessionData) {
        localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
      },
      
      clearSession: function() {
        localStorage.removeItem(SESSION_KEY);
      },
      
      getSessionId: function() {
        const session = this.getSession();
        return session ? session.sessionId : null;
      }
    };
    
    // ==================== API CLIENT ====================
    const apiClient = {
      async call(action, params = {}) {
        try {
          const sessionId = sessionManager.getSessionId();
          const payload = { action, sessionId, ...params };
          
          // Use GET with URL parameter to avoid CORS preflight issues
          const encodedData = encodeURIComponent(JSON.stringify(payload));
          const url = `${APPS_SCRIPT_URL}?data=${encodedData}`;
          
          const response = await fetch(url, { method: 'GET', redirect: 'follow' });
          const result = await response.json();
          
          // Handle session expiration
          if (!result.isOk && result.error && result.error.includes('session')) {
            sessionManager.clearSession();
            window.location.reload();
          }
          
          return result;
        } catch (error) {
          console.error('API call failed:', error);
          return { isOk: false, error: error.message || 'Network error' };
        }
      }
    };
    
    // ==================== ELEMENT SDK ====================
    window.elementSdk = {
      init: async function(options) {
        if (options.onConfigChange) {
          const savedConfig = localStorage.getItem('myiskcon_config');
          const config = savedConfig ? JSON.parse(savedConfig) : options.defaultConfig;
          options.onConfigChange(config);
        }
        return { isOk: true };
      }
    };

    // ==================== DATA SDK ====================
    window.dataSdk = {
      _handler: null,
      _cachedData: null,
      _dataLoaded: false,
      _loadingPromise: null,
      
      // Initialize SDK
      init: async function(handler) {
        this._handler = handler;
        this._cachedData = [];
        return { isOk: true };
      },
      
      // Ensure data is loaded (lazy loading)
      ensureDataLoaded: async function() {
        if (this._dataLoaded) return { isOk: true };
        if (this._loadingPromise) return this._loadingPromise;
        
        this._loadingPromise = (async () => {
          const dataResult = await apiClient.call('getAllData');
          if (dataResult.isOk) {
            this._cachedData = dataResult.data;
            this._dataLoaded = true;
            if (this._handler && this._handler.onDataChanged) {
              this._handler.onDataChanged(dataResult.data);
            }
          }
          this._loadingPromise = null;
          return dataResult;
        })();
        
        return this._loadingPromise;
      },
      
      // Get cached data (returns immediately)
      getCachedData: function() {
        return this._cachedData || [];
      },
      
      // Notify handler of data change
      _notifyChange: function() {
        if (this._handler && this._handler.onDataChanged) {
          this._handler.onDataChanged(this._cachedData);
        }
      },
      
      // Create a new record - updates local cache immediately
      create: async function(record) {
        const result = await apiClient.call('create', { record });
        if (result.isOk && result.data) {
          // Add to local cache immediately (no need to re-fetch everything)
          if (!this._cachedData) this._cachedData = [];
          this._cachedData.push(result.data);
          this._notifyChange();
        }
        return result;
      },
      
      // Update an existing record - updates local cache immediately
      update: async function(record) {
        const result = await apiClient.call('update', { record });
        if (result.isOk) {
          // Update in local cache immediately
          const index = this._cachedData.findIndex(d => d.__backendId === record.__backendId);
          if (index >= 0) {
            this._cachedData[index] = { ...this._cachedData[index], ...record, updatedAt: new Date().toISOString() };
          }
          this._notifyChange();
        }
        return result;
      },
      
      // Delete a record - updates local cache immediately
      delete: async function(record) {
        const result = await apiClient.call('delete', { record });
        if (result.isOk) {
          // Remove from local cache immediately
          this._cachedData = this._cachedData.filter(d => d.__backendId !== record.__backendId);
          this._notifyChange();
        }
        return result;
      },
      
      // Force refresh data from backend (use sparingly)
      refreshData: async function() {
        this._dataLoaded = false;
        return this.ensureDataLoaded();
      },
      
      // Clear cache (on logout)
      clearCache: function() {
        this._cachedData = [];
        this._dataLoaded = false;
        this._loadingPromise = null;
      }
    };
    
    // ==================== AUTH SDK ====================
    window.authSdk = {
      // Login with username and password
      login: async function(username, password) {
        const result = await apiClient.call('login', { 
          username, 
          password,
          ipAddress: '',
          userAgent: navigator.userAgent
        });
        
        if (result.isOk) {
          sessionManager.setSession({
            sessionId: result.sessionId,
            user: result.user
          });
          // Data loading is now handled by the caller for better control
        }
        
        return result;
      },
      
      // Logout
      logout: async function() {
        await apiClient.call('logout');
        sessionManager.clearSession();
        window.dataSdk.clearCache();
        return { isOk: true };
      },
      
      // Change password
      changePassword: async function(currentPassword, newPassword) {
        return await apiClient.call('changePassword', { currentPassword, newPassword });
      },
      
      // Get current session
      getSession: function() {
        return sessionManager.getSession();
      },
      
      // Check if user is logged in
      isLoggedIn: function() {
        const session = sessionManager.getSession();
        return session !== null && session.user !== null;
      },
      
      // Validate current session
      validateSession: async function() {
        const result = await apiClient.call('validateSession');
        if (!result.isOk) {
          sessionManager.clearSession();
        }
        return result;
      }
    };
    
    // ==================== SECURITY UTILITIES ====================
    window.securityUtils = {
      maskPAN: function(pan) {
        if (!pan || pan.length < 4) return '***';
        return 'XXXXXX' + pan.slice(-4);
      },
      maskMobile: function(mobile) {
        if (!mobile || mobile.length < 4) return '***';
        return mobile.slice(0, 2) + '****' + mobile.slice(-4);
      },
      maskEmail: function(email) {
        if (!email || !email.includes('@')) return '***';
        const [user, domain] = email.split('@');
        if (user.length <= 2) return email;
        return user.slice(0, 2) + '***@' + domain;
      },
      sanitizeInput: function(input) {
        if (typeof input !== 'string') return input;
        return input.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      },
      isValidPAN: function(pan) {
        return /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(pan);
      },
      isValidMobile: function(mobile) {
        return /^[6-9][0-9]{9}$/.test(mobile);
      },
      isValidEmail: function(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600;700&amp;family=Inter:wght@400;500;600&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    .font-display {
      font-family: 'Crimson Pro', serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fbbf24 100%);
    }
    .card-shadow {
      box-shadow: 0 4px 20px rgba(180, 83, 9, 0.15);
    }
    .btn-primary {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #b45309 0%, #92400e 100%);
      transform: translateY(-1px);
    }
    .tab-active {
      border-bottom: 3px solid #d97706;
      color: #92400e;
    }
    .seva-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(180, 83, 9, 0.2);
    }
    .toast {
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    .permission-card {
      border: 2px solid #e5c547;
      border-radius: 8px;
      padding: 16px;
      background: #fffef5;
      transition: all 0.2s ease;
    }
    .permission-card:hover {
      border-color: #d97706;
      box-shadow: 0 4px 12px rgba(217, 119, 6, 0.1);
    }
    .permission-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #d97706;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-amber-50">
  <div id="app" class="h-full overflow-auto"><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div><!-- Login Screen -->
   <div id="login-screen" class="min-h-full flex flex-col p-4">
    <div class="flex-1 flex items-center justify-center">
     <div class="w-full max-w-md">
      <div class="text-center mb-8">
       <div class="w-28 h-28 mx-auto mb-4 flex items-center justify-center"><img src="https://iskconsouthbengaluru.com/wp-content/uploads/sites/7/2022/03/cropped-ISB-vertical-logo-Red-2.png" alt="ISKCON South Bengaluru Logo" style="max-width:100%; height:auto; object-fit:contain;" onerror="this.style.display='none'">
       </div>
       <h1 id="temple-title" class="font-display text-3xl font-bold text-amber-900">My ISKCON Accounts</h1>
       <p id="welcome-text" class="text-amber-700 mt-2">Account Management System</p>
      </div>
      <div class="bg-white rounded-2xl card-shadow p-8">
       <h2 class="font-display text-2xl font-semibold text-amber-900 mb-6 text-center">Login</h2>
       <form id="login-form" class="space-y-4">
        <div><label for="login-username" class="block text-sm font-medium text-amber-800 mb-1">Username</label> <input type="text" id="login-username" class="w-full px-4 py-3 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition" placeholder="Enter username">
        </div>
        <div><label for="login-password" class="block text-sm font-medium text-amber-800 mb-1">Password</label> <input type="password" id="login-password" class="w-full px-4 py-3 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none transition" placeholder="Enter password">
        </div>
        <div id="login-error" class="text-red-600 text-sm hidden"></div><button type="submit" class="w-full btn-primary text-white py-3 rounded-lg font-semibold"> Login </button>
       </form>
       <div class="mt-6 pt-6 border-t border-amber-200">
        <p class="text-center text-amber-600 text-sm font-medium mb-3">Demo Accounts:</p>
        <div class="space-y-2 text-sm text-amber-700">
         <p><strong>Superadmin:</strong> admin / admin</p>
         <p><strong>Admin 1:</strong> admin1 / admin1</p>
         <p><strong>Admin 2:</strong> admin2 / admin2</p>
         <p><strong>Volunteer:</strong> volunteer1 / volunteer1</p>
        </div>
       </div>
      </div>
     </div>
    </div>
    <footer class="mt-auto py-6 text-center text-amber-800 text-sm border-t border-amber-200/60">
     <p class="font-medium">Contact: <a href="mailto:iccabhilekhah@gmail.com" class="text-amber-700 hover:text-amber-900 underline">iccabhilekhah@gmail.com</a> &nbsp;|&nbsp; Phone: <a href="tel:+918073222508" class="text-amber-700 hover:text-amber-900 underline">+91-8073222508</a></p>
     <p class="mt-1 text-amber-700">Address: No.1, Samvruddhi Enclave, 3rd Main, Bangalore-560111, India</p>
     <p class="mt-3 text-amber-600 text-xs">¬© <span id="footer-year"></span> ISKCON Cultural Centre. All rights reserved.</p>
    </footer>
   </div><!-- Main Dashboard -->
   <div id="dashboard" class="hidden min-h-full flex flex-col"><!-- Header -->
    <header class="bg-white border-b border-amber-200 px-4 py-3">
     <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
       <div class="w-12 h-12 flex items-center justify-center flex-shrink-0"><img src="https://iskconsouthbengaluru.com/wp-content/uploads/sites/7/2022/03/cropped-ISB-vertical-logo-Red-2.png" alt="ISKCON South Bengaluru Logo" style="max-width:100%; height:auto; object-fit:contain;" onerror="this.style.display='none'">
       </div>
       <div>
        <h1 id="dashboard-title" class="font-display text-xl font-bold text-amber-900">My ISKCON Accounts</h1>
        <p id="user-role-display" class="text-xs text-amber-600"></p>
       </div>
      </div><button id="logout-btn" class="flex items-center gap-2 text-amber-700 hover:text-amber-900 transition">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
       </svg><span class="hidden sm:inline">Logout</span> </button>
     </div>
    </header><!-- Navigation Tabs -->
    <nav class="bg-white border-b border-amber-200">
     <div class="max-w-7xl mx-auto">
      <div id="nav-tabs" class="flex overflow-x-auto"><button data-tab="dashboard" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition tab-active"> Dashboard </button> <button data-tab="booking" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition" id="booking-tab"> Booking </button> <button data-tab="reports" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition" id="reports-tab"> Reports </button> <button data-tab="donors" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition admin-only hidden" id="donors-tab"> Donors </button> <button data-tab="sevas" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition admin-only hidden" id="sevas-tab"> Manage Sevas </button> <button data-tab="users" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition admin-only hidden" id="users-tab"> Users </button> <button data-tab="permissions" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition superadmin-only hidden" id="permissions-tab"> üîê Manage Access </button> <button data-tab="donor-logins" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition admin-only hidden" id="donor-logins-tab"> üîë Donor Logins </button> <button data-tab="centers" class="tab-btn px-6 py-4 text-amber-700 font-medium whitespace-nowrap hover:bg-amber-50 transition superadmin-only hidden" id="centers-tab"> üèõÔ∏è Centers </button>
      </div>
     </div>
    </nav><!-- Tab Content -->
    <main class="flex-1 p-4 overflow-auto">
     <div class="max-w-7xl mx-auto"><!-- Dashboard Tab -->
      <div id="tab-dashboard" class="tab-content">
       <div class="space-y-6"><!-- Statistics Cards -->
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
         <div class="bg-white rounded-xl card-shadow p-6">
          <p class="text-amber-600 text-sm font-medium mb-1">Total Bookings</p>
          <p id="stat-bookings" class="font-display text-3xl font-bold text-amber-900">0</p>
         </div>
         <div class="bg-white rounded-xl card-shadow p-6">
          <p class="text-amber-600 text-sm font-medium mb-1">Total Revenue</p>
          <p id="stat-revenue" class="font-display text-3xl font-bold text-amber-900">0</p>
         </div>
         <div class="bg-white rounded-xl card-shadow p-6">
          <p class="text-amber-600 text-sm font-medium mb-1">Total Donors</p>
          <p id="stat-donors" class="font-display text-3xl font-bold text-amber-900">0</p>
         </div>
         <div class="bg-white rounded-xl card-shadow p-6">
          <p class="text-amber-600 text-sm font-medium mb-1">Avg. Transaction</p>
          <p id="stat-average" class="font-display text-3xl font-bold text-amber-900">0</p>
         </div>
        </div><!-- Filters -->
        <div class="bg-white rounded-xl card-shadow p-6">
         <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Filters and Analytics</h3>
         <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div><label class="block text-sm font-medium text-amber-700 mb-2">Filter by Seva</label> <select id="filter-seva" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"> <option value="">All Sevas</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-amber-700 mb-2">Date Range</label> <select id="filter-date" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"> <option value="all">All Time</option> <option value="today">Today</option> <option value="week">This Week</option> <option value="month">This Month</option> <option value="year">This Year</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-amber-700 mb-2">Start Date</label> <input type="date" id="filter-start-date" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div><label class="block text-sm font-medium text-amber-700 mb-2">End Date</label> <input type="date" id="filter-end-date" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
         </div>
        </div><!-- Charts -->
        <div class="grid lg:grid-cols-2 gap-6"><!-- Revenue by Seva -->
         <div class="bg-white rounded-xl card-shadow p-6">
          <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Revenue by Seva</h3>
          <canvas id="chart-seva" style="max-height: 300px;"></canvas>
         </div><!-- Revenue Trend -->
         <div class="bg-white rounded-xl card-shadow p-6">
          <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Revenue Trend</h3>
          <canvas id="chart-trend" style="max-height: 300px;"></canvas>
         </div>
        </div><!-- Top Sevas Table -->
        <div class="bg-white rounded-xl card-shadow p-6">
         <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Top Performing Sevas</h3>
         <div class="overflow-x-auto">
          <table class="w-full">
           <thead>
            <tr class="border-b border-amber-200">
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Seva Name</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Bookings</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Total Revenue</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Avg Amount</th>
            </tr>
           </thead>
           <tbody id="top-sevas-body">
            <tr>
             <td colspan="4" class="py-4 text-center text-amber-600">No data available</td>
            </tr>
           </tbody>
          </table>
         </div>
        </div><!-- Transactions List -->
        <div class="bg-white rounded-xl card-shadow p-6">
         <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Filtered Transactions</h3>
         <div class="overflow-x-auto">
          <table class="w-full">
           <thead>
            <tr class="border-b border-amber-200">
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Date</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Donor Name</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Sevas</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Amount</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Status</th>
            </tr>
           </thead>
           <tbody id="filtered-transactions-body">
            <tr>
             <td colspan="5" class="py-4 text-center text-amber-600">No transactions available</td>
            </tr>
           </tbody>
          </table>
         </div>
        </div>
       </div>
      </div><!-- Booking Tab -->
      <div id="tab-booking" class="tab-content hidden">
       <div class="grid lg:grid-cols-3 gap-6"><!-- Search & Donor Info -->
        <div class="lg:col-span-1 space-y-4">
         <div class="bg-white rounded-xl card-shadow p-6">
          <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Search Donor</h3>
          <div class="relative">
           <div class="flex gap-2"><input type="tel" id="search-mobile" class="flex-1 px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Start typing mobile number..."> <button id="search-donor-btn" class="btn-primary text-white px-4 py-2 rounded-lg">
             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
             </svg></button>
           </div>
           <div id="search-dropdown" class="absolute top-full left-0 right-12 mt-1 bg-white border border-amber-300 rounded-lg shadow-lg hidden max-h-48 overflow-y-auto z-20"><!-- Dropdown items will be populated here -->
           </div>
          </div>
          <div id="search-result" class="mt-3 text-sm"></div>
         </div>
         <div class="bg-white rounded-xl card-shadow p-6">
          <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Donor Details</h3>
          <form id="donor-form" class="space-y-3"><input type="hidden" id="donor-id">
           <div><label class="block text-xs font-medium text-amber-700 mb-1">Legal Name *</label> <input type="text" id="donor-name" required class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Full name (First and Last)">
           </div>
           <div><label class="block text-xs font-medium text-amber-700 mb-1">Spiritual Name (Optional)</label> <input type="text" id="donor-spiritual-name" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Initiated name if applicable">
           </div>
           <div class="flex items-center gap-2 py-1">
             <input type="checkbox" id="donor-indian-passport" class="w-4 h-4 text-amber-600 border-amber-300 rounded focus:ring-amber-500">
             <label for="donor-indian-passport" class="text-xs font-medium text-amber-700">Indian Passport Holder</label>
           </div>
           <div><label class="block text-xs font-medium text-amber-700 mb-1">PAN Number</label> <input type="text" id="donor-pan" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none uppercase" placeholder="ABCDE1234F" maxlength="10">
           </div>
           <div><label class="block text-xs font-medium text-amber-700 mb-1">Mobile Number *</label> <input type="tel" id="donor-mobile" required class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" data-auto-populate="donor-whatsapp">
           </div>
           <div><label class="block text-xs font-medium text-amber-700 mb-1">WhatsApp Number</label> <input type="tel" id="donor-whatsapp" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Auto-filled from mobile">
           </div>
           <div><label class="block text-xs font-medium text-amber-700 mb-1">Email</label> <input type="email" id="donor-email" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
           </div><!-- Address Fields -->
           <div class="border-t border-amber-200 pt-3 mt-3">
            <p class="text-xs font-semibold text-amber-800 mb-2">Address Details</p>
            <div><label class="block text-xs font-medium text-amber-700 mb-1">Flat / Door / Building</label> <input type="text" id="donor-flat" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            <div><label class="block text-xs font-medium text-amber-700 mb-1 mt-2">Road / Street / Block / Sector</label> <input type="text" id="donor-road" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            <div><label class="block text-xs font-medium text-amber-700 mb-1 mt-2">Post Office</label> <input type="text" id="donor-po" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            <div><label class="block text-xs font-medium text-amber-700 mb-1 mt-2">Area / Locality</label> <input type="text" id="donor-area" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            <div><label class="block text-xs font-medium text-amber-700 mb-1 mt-2">Pincode *</label> <input type="text" id="donor-pincode" maxlength="6" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
             <div id="pincode-status" class="text-xs mt-1 text-amber-600"></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
             <div><label class="block text-xs font-medium text-amber-700 mb-1">District</label> <input type="text" id="donor-district" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly>
             </div>
             <div><label class="block text-xs font-medium text-amber-700 mb-1">State</label> <input type="text" id="donor-state" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly>
             </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
             <div><label class="block text-xs font-medium text-amber-700 mb-1">Country</label> <input type="text" id="donor-country" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly value="India">
             </div>
             <div><label class="block text-xs font-medium text-amber-700 mb-1">Center *</label>
              <select id="donor-center" required class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
               <!-- Centers populated dynamically -->
              </select>
             </div>
            </div>
           </div>
          </form>
         </div>
        </div><!-- Seva Selection & Date -->
        <div class="lg:col-span-1">
         <div class="bg-white rounded-xl card-shadow p-6 h-full flex flex-col">
          <div class="flex items-center justify-between mb-3">
           <h3 class="font-display text-lg font-semibold text-amber-900">Select Sevas</h3>
           <button id="browse-sevas-btn" class="text-amber-600 hover:text-amber-800 text-sm font-medium flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            More Options
           </button>
          </div>
          <!-- Quick Seva Selection Grid -->
          <div id="quick-seva-grid" class="grid grid-cols-2 gap-2 mb-4">
           <!-- Quick seva buttons will be populated here -->
          </div>
          <p class="text-xs text-amber-600 mb-2">Click to add seva ‚Ä¢ Selected sevas shown below</p>
          <div id="seva-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 flex-1"><!-- Selected sevas will be shown here -->
          </div>
         </div>
        </div><!-- Cart & Checkout -->
        <div class="lg:col-span-1">
         <div class="bg-white rounded-xl card-shadow p-6 sticky top-4">
          <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Booking Summary</h3>
          <div id="cart-items" class="space-y-2 mb-4 max-h-48 overflow-y-auto">
           <p class="text-amber-600 text-sm">No sevas selected</p>
          </div>
          <div class="border-t border-amber-200 pt-4 mb-4">
           <div class="flex justify-between items-center text-lg font-semibold"><span class="text-amber-800">Total Amount:</span> <span id="total-amount" class="text-amber-900">0</span>
           </div>
          </div>
          <div class="flex items-center gap-2 py-2 mb-2">
           <input type="checkbox" id="booking-festival-qr" class="w-4 h-4 text-amber-600 border-amber-300 rounded focus:ring-amber-500">
           <label for="booking-festival-qr" class="text-sm font-medium text-amber-800">Festival booking ‚Äì Include QR codes (Darshan &amp; Prasadam) for validation</label>
          </div>
          <div class="space-y-3"><button id="save-booking-btn" class="w-full btn-primary text-white py-3 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed"> Save Booking </button> <button id="razorpay-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition">
            <svg class="w-5 h-5" viewbox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
            </svg> Pay with Razorpay </button>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Donors Tab -->
      <div id="tab-donors" class="tab-content hidden">
       <div class="bg-white rounded-xl card-shadow p-6">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
         <h3 class="font-display text-xl font-semibold text-amber-900">Registered Donors</h3>
         <div class="flex gap-2">
          <div class="relative">
           <button id="download-donors-dropdown-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            Download
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
           </button>
           <div id="download-donors-dropdown" class="hidden absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
            <button id="download-donors-excel" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 rounded-t-lg flex items-center gap-2">
             <span class="w-6 text-green-600 font-bold">XLS</span> Excel (.xlsx)
            </button>
            <button id="download-donors-csv" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 flex items-center gap-2">
             <span class="w-6 text-blue-600 font-bold">CSV</span> CSV (.csv)
            </button>
            <button id="download-donors-xml" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-purple-50 hover:text-purple-700 flex items-center gap-2">
             <span class="w-6 text-purple-600 font-bold">XML</span> XML (.xml)
            </button>
            <button id="download-donors-json" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 rounded-b-lg flex items-center gap-2">
             <span class="w-6 text-orange-600 font-bold">{ }</span> JSON (.json)
            </button>
           </div>
          </div>
          <button id="add-donor-btn" class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
           </svg> Add Donor
          </button>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-amber-200">
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">S.No</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Name</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Mobile</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">WhatsApp</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Email</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Address</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Bookings</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Total Donated</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Last Donation</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Actions</th>
           </tr>
          </thead>
          <tbody id="donors-table-body"><!-- Donors will be populated here -->
          </tbody>
         </table>
        </div>
        <div id="no-donors" class="text-center py-8 text-amber-600 hidden">
         <p>No donors registered yet.</p>
        </div>
       </div>
      </div><!-- Manage Sevas Tab -->
      <div id="tab-sevas" class="tab-content hidden">
       <div class="bg-white rounded-xl card-shadow p-6">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
         <h3 class="font-display text-xl font-semibold text-amber-900">Manage Sevas / Donations</h3><button id="add-seva-btn" class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg> Add Seva </button>
        </div>
        <div id="sevas-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"><!-- Sevas will be populated here -->
        </div>
        <div id="no-sevas" class="text-center py-8 text-amber-600 hidden">
         <p>No sevas configured yet.</p>
        </div>
       </div>
      </div><!-- Users Tab -->
      <div id="tab-users" class="tab-content hidden">
       <div class="bg-white rounded-xl card-shadow p-6 space-y-4">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
         <h3 class="font-display text-xl font-semibold text-amber-900">Manage Users</h3><button id="add-user-btn" class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg> Add User </button>
        </div>
        <div class="flex flex-col sm:flex-row gap-4 pb-4 border-b border-amber-200">
         <div class="flex-1"><label class="block text-sm font-medium text-amber-700 mb-2">Filter by Center</label> <select id="users-center-filter" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"> <option value="">All Centers</option> <option value="center_bangalore">Bangalore Center</option> <option value="center_delhi">Delhi Center</option> <option value="center_mumbai">Mumbai Center</option> <option value="center_chennai">Chennai Center</option> <option value="center_kolkata">Kolkata Center</option> </select>
         </div>
        </div>
        <div class="overflow-x-auto">
         <table class="w-full">
          <thead>
           <tr class="border-b border-amber-200">
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Username</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Role</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Center</th>
            <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Actions</th>
           </tr>
          </thead>
          <tbody id="users-table-body"><!-- Users will be populated here -->
          </tbody>
         </table>
        </div>
       </div>
      </div><!-- Permissions Tab (Superadmin Only) -->
      <div id="tab-permissions" class="tab-content hidden">
       <div class="space-y-6">
        <div class="bg-white rounded-xl card-shadow p-6">
         <h3 class="font-display text-2xl font-semibold text-amber-900 mb-2">üîê Manage User Access</h3>
         <p class="text-amber-600 mb-6">Control what features each admin can access. Check or uncheck permissions below.</p>
         <div id="permissions-container" class="grid grid-cols-1 gap-4"><!-- Permission cards will be populated here -->
         </div>
        </div>
       </div>
      </div><!-- Donor Logins Tab (Superadmin Only) -->
      <div id="tab-donor-logins" class="tab-content hidden">
       <div class="space-y-6">
        <div class="bg-white rounded-xl card-shadow p-6">
         <h3 class="font-display text-2xl font-semibold text-amber-900 mb-2">üîë Donor Login Credentials</h3>
         <p class="text-amber-600 mb-4">Share these login details with donors so they can access their donation history and make new donations.</p>
         <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-amber-800"><strong>Note:</strong> For demo purposes, both username and password are the donor's Legal Name. Donors can view their own bookings, download PDF reports, and make new donations.</p>
         </div>
         <!-- Filters -->
         <div id="donor-logins-filter" class="mb-4 hidden">
          <div class="grid sm:grid-cols-2 gap-4">
           <div>
            <label class="block text-sm font-medium text-amber-700 mb-2">Filter by Center</label>
            <select id="donor-logins-center-filter" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
             <option value="">All Centers</option>
             <!-- Centers populated dynamically -->
            </select>
           </div>
           <div class="relative">
            <label class="block text-sm font-medium text-amber-700 mb-2">Search Donor</label>
            <input type="text" id="donor-logins-search" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Type name or mobile...">
            <div id="donor-logins-search-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-amber-200 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
             <!-- Search results will appear here -->
            </div>
           </div>
          </div>
         </div>
         <div class="overflow-x-auto">
          <table class="w-full">
           <thead class="bg-amber-100">
            <tr>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">#</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Legal Name</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Spiritual Name</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Mobile</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Username</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Password</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Total Donations</th>
            </tr>
           </thead>
           <tbody id="donor-logins-table-body">
            <!-- Donor logins will be populated here -->
           </tbody>
          </table>
         </div>
         <p id="no-donor-logins" class="text-amber-600 text-center py-8 hidden">No donors found.</p>
        </div>
       </div>
      </div><!-- Centers Tab (Superadmin Only) -->
      <div id="tab-centers" class="tab-content hidden">
       <div class="space-y-6">
        <div class="bg-white rounded-xl card-shadow p-6">
         <div class="flex items-center justify-between mb-6">
          <div>
           <h3 class="font-display text-2xl font-semibold text-amber-900 mb-2">üèõÔ∏è Center Management</h3>
           <p class="text-amber-600">Add, edit, or remove centers. Changes will reflect across all dropdowns.</p>
          </div>
          <button id="add-center-btn" class="btn-primary text-white px-4 py-2 rounded-lg flex items-center gap-2">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
           Add Center
          </button>
         </div>
         <div class="overflow-x-auto">
          <table class="w-full">
           <thead class="bg-amber-100">
            <tr>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">#</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Center ID</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Center Name</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">City</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">State</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Donors</th>
             <th class="text-left py-3 px-4 text-amber-900 font-semibold">Actions</th>
            </tr>
           </thead>
           <tbody id="centers-table-body">
            <!-- Centers will be populated here -->
           </tbody>
          </table>
         </div>
         <p id="no-centers" class="text-amber-600 text-center py-8 hidden">No centers found. Add your first center!</p>
        </div>
       </div>
      </div><!-- Reports Tab -->
      <div id="tab-reports" class="tab-content hidden">
       <div class="space-y-6"><!-- Filters -->
        <div class="bg-white rounded-xl card-shadow p-6">
         <h3 class="font-display text-lg font-semibold text-amber-900 mb-4">Filter Reports</h3>
         <div class="grid sm:grid-cols-2 lg:grid-cols-5 gap-4">
          <div><label class="block text-sm font-medium text-amber-700 mb-2">Status</label> <select id="report-status-filter" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"> <option value="">All Status</option> <option value="paid">Paid</option> <option value="pending">Pending</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-amber-700 mb-2">Collected By</label> <select id="report-collector-filter" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"> <option value="">All Collectors</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-amber-700 mb-2">Date Range</label> <select id="report-date-filter" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"> <option value="all">All Time</option> <option value="today">Today</option> <option value="week">This Week</option> <option value="month">This Month</option> <option value="year">This Year</option> </select>
          </div>
          <div><label class="block text-sm font-medium text-amber-700 mb-2">Start Date</label> <input type="date" id="report-start-date" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div><label class="block text-sm font-medium text-amber-700 mb-2">End Date</label> <input type="date" id="report-end-date" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
         </div>
        </div><!-- Bookings Table -->
        <div class="bg-white rounded-xl card-shadow p-6">
         <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
          <h3 class="font-display text-lg font-semibold text-amber-900">Booking Reports</h3>
          <div class="relative">
           <button id="download-reports-dropdown-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            Download
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
           </button>
           <div id="download-reports-dropdown" class="hidden absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
            <button id="download-reports-excel" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 rounded-t-lg flex items-center gap-2">
             <span class="w-6 text-green-600 font-bold">XLS</span> Excel (.xlsx)
            </button>
            <button id="download-reports-csv" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 flex items-center gap-2">
             <span class="w-6 text-blue-600 font-bold">CSV</span> CSV (.csv)
            </button>
            <button id="download-reports-xml" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-purple-50 hover:text-purple-700 flex items-center gap-2">
             <span class="w-6 text-purple-600 font-bold">XML</span> XML (.xml)
            </button>
            <button id="download-reports-json" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 flex items-center gap-2">
             <span class="w-6 text-orange-600 font-bold">{ }</span> JSON (.json)
            </button>
            <button id="download-reports-pdf" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-red-50 hover:text-red-700 rounded-b-lg flex items-center gap-2">
             <span class="w-6 text-red-600 font-bold">PDF</span> PDF Report
            </button>
           </div>
          </div>
         </div>
         <div class="overflow-x-auto">
          <table class="w-full">
           <thead>
            <tr class="border-b border-amber-200">
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Date</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Donor</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Sevas</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Amount</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Collected By</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Center</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Status</th>
             <th class="text-left py-3 px-4 text-amber-700 font-medium text-sm">Actions</th>
            </tr>
           </thead>
           <tbody id="reports-table-body"><!-- Reports will be populated here -->
           </tbody>
          </table>
         </div>
         <div id="no-reports" class="text-center py-8 text-amber-600 hidden">
          <p>No bookings recorded yet.</p>
         </div>
        </div>
       </div>
      </div>
     </div>
    </main>
   </div><!-- Seva Slide-Out Panel -->
   <div id="seva-panel-backdrop" class="fixed inset-0 z-30 hidden modal-backdrop"></div>
   <div id="seva-slide-panel" class="fixed right-0 top-0 h-full w-96 bg-white shadow-2xl z-40 hidden flex flex-col overflow-hidden">
    <div class="flex items-center justify-between p-6 border-b border-amber-200 flex-shrink-0">
     <h3 class="font-display text-xl font-semibold text-amber-900">Available Sevas</h3><button id="close-seva-panel-btn" class="text-amber-600 hover:text-amber-800 transition">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div>
    <div id="sliding-seva-list" class="flex-1 overflow-y-auto p-4 space-y-3"><!-- Sevas will be populated here -->
    </div>
    <div class="p-4 border-t border-amber-200 flex-shrink-0"><button id="finish-seva-selection-btn" class="w-full btn-primary text-white py-3 rounded-lg font-semibold"> Done Selecting </button>
    </div>
   </div><!-- Modal Container -->
   <div id="modal-container" class="fixed inset-0 z-40 hidden">
    <div class="modal-backdrop absolute inset-0" id="modal-backdrop"></div>
    <div class="relative flex items-center justify-center min-h-full p-4">
     <div id="modal-content" class="bg-white rounded-2xl card-shadow p-6 relative" style="width: 210mm; height: 148mm; max-width: 90vw; max-height: 90vh; overflow-y: auto;"><!-- Modal content will be injected here -->
     </div>
    </div>
   </div>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      temple_name: 'My ISKCON Accounts',
      welcome_message: 'Account Management System',
      background_color: '#fffbeb',
      surface_color: '#ffffff',
      text_color: '#78350f',
      primary_action_color: '#d97706',
      secondary_action_color: '#b45309',
      font_family: 'Inter',
      font_size: 16
    };

    // Available Permissions
    const allPermissions = [
      { id: 'view_dashboard', label: 'View Dashboard', default: true },
      { id: 'booking', label: 'Manage Bookings', default: true },
      { id: 'reports', label: 'View Reports', default: true },
      { id: 'manage_donors', label: 'Manage Donors', default: false },
      { id: 'manage_sevas', label: 'Manage Sevas', default: false },
      { id: 'manage_users', label: 'Manage Users', default: false },
      { id: 'donor_logins', label: 'View Donor Logins', default: false },
      { id: 'receipts', label: 'Download Receipts', default: true }
    ];

    // Demo Centers (reference data)
    const demoCenters = [
      { id: 'center_bangalore', name: 'Bangalore Center', city: 'Bengaluru', state: 'Karnataka' },
      { id: 'center_delhi', name: 'Delhi Center', city: 'New Delhi', state: 'Delhi' },
      { id: 'center_mumbai', name: 'Mumbai Center', city: 'Mumbai', state: 'Maharashtra' },
      { id: 'center_chennai', name: 'Chennai Center', city: 'Chennai', state: 'Tamil Nadu' },
      { id: 'center_kolkata', name: 'Kolkata Center', city: 'Kolkata', state: 'West Bengal' }
    ];

    // Load centers from localStorage or use demo
    let centersList = JSON.parse(localStorage.getItem('myiskcon_centers') || 'null') || [...demoCenters];

    function saveCenters() {
      localStorage.setItem('myiskcon_centers', JSON.stringify(centersList));
    }

    function getCenterName(centerId) {
      if (!centerId || centerId === 'all_centers') return 'All Centers';
      const center = centersList.find(c => c.id === centerId);
      return center ? center.name : centerId;
    }

    // Demo Sevas (reference data)
    const demoSevas = [
      { id: 'seva1', name: 'Abhishekam', description: 'Sacred bathing ritual', amount: 501 },
      { id: 'seva2', name: 'Archana', description: 'Chanting of divine names', amount: 51 },
      { id: 'seva3', name: 'Sahasranama Archana', description: '1008 names recitation', amount: 251 },
      { id: 'seva4', name: 'Annadanam', description: 'Food offering sponsorship', amount: 1001 },
      { id: 'seva5', name: 'Deepotsavam', description: 'Lamp lighting ceremony', amount: 151 },
      { id: 'seva6', name: 'Pushparchana', description: 'Flower offering ritual', amount: 301 },
      { id: 'seva7', name: 'Kumkum Archana', description: 'Vermillion offering', amount: 101 },
      { id: 'seva8', name: 'Special Puja', description: 'Elaborate worship service', amount: 1501 }
    ];

    // App State
    let currentUser = null;
    let allData = [];
    let cart = [];
    // Load sevas from localStorage or use defaults
    let sevasList = JSON.parse(localStorage.getItem('myiskcon_sevas')) || [...demoSevas];
    let chartSevaInstance = null;
    let chartTrendInstance = null;

    // Save sevas to localStorage
    function saveSevas() {
      localStorage.setItem('myiskcon_sevas', JSON.stringify(sevasList));
    }

    // Helper Functions
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-amber-600';
      toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg max-w-sm`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function hasPermission(permissionId) {
      if (!currentUser) return false;
      if (currentUser.username === 'admin') return true; // Superadmin has all permissions
      
      // Donor role has limited permissions
      if (currentUser.role === 'donor') {
        const donorPermissions = ['booking', 'reports'];
        return donorPermissions.includes(permissionId);
      }
      
      try {
        const perms = currentUser.permissions ? JSON.parse(currentUser.permissions) : {};
        return perms[permissionId] === true;
      } catch (e) {
        return false;
      }
    }

    function getUserPermissions(user) {
      try {
        return user.permissions ? JSON.parse(user.permissions) : {};
      } catch (e) {
        return {};
      }
    }

    function getUsers() {
      return getCenterUsers();
    }

    function getCenterData(dataType) {
      if (!currentUser) return [];
      
      // Superadmin sees all data across all centers
      if (currentUser.username === 'admin') {
        return allData.filter(d => d.type === dataType);
      }
      
      // Other users only see data from their center
      const userCenterId = currentUser.centerId;
      return allData.filter(d => d.type === dataType && d.centerId === userCenterId);
    }

    function getDonors() {
      if (!currentUser) return [];
      
      // Superadmin sees all donors
      if (currentUser.username === 'admin') {
        return allData.filter(d => d.type === 'donor');
      }
      
      // Other users see donors from their center
      return allData.filter(d => d.type === 'donor' && d.centerId === currentUser.centerId);
    }

    // Get list of users created by current user (for admins)
    function getCreatedUsernames() {
      if (!currentUser) return [];
      
      // Find all users created by the current user
      const createdUsers = allData.filter(d => 
        d.type === 'user' && d.createdBy === currentUser.username
      );
      
      // Return array of usernames including current user
      const usernames = createdUsers.map(u => u.username);
      usernames.push(currentUser.username);
      return usernames;
    }

    function getBookings() {
      if (!currentUser) return [];
      
      // Donor only sees their own bookings
      if (currentUser.role === 'donor') {
        return allData.filter(d => d.type === 'booking' && d.donorId === currentUser.donorId);
      }
      
      // Superadmin sees all bookings
      if (currentUser.username === 'admin') {
        return allData.filter(d => d.type === 'booking');
      }
      
      // Get list of usernames whose bookings this user can see
      const allowedCollectors = getCreatedUsernames();
      
      // Filter bookings: 
      // 1. Must be from same center OR collected by allowed users
      // 2. Exclude superadmin bookings (collectedBy !== 'admin')
      return allData.filter(d => {
        if (d.type !== 'booking') return false;
        
        // Never show superadmin bookings to regular users
        if (d.collectedBy === 'admin') return false;
        
        // Show if collected by current user or users they created
        if (allowedCollectors.includes(d.collectedBy)) return true;
        
        return false;
      });
    }

    function getCenterUsers() {
      if (!currentUser) return [];
      
      // Superadmin sees all users across all centers
      if (currentUser.username === 'admin') {
        return allData.filter(d => d.type === 'user' && d.username !== 'admin');
      }
      
      // Admins see only users they created
      return allData.filter(d => 
        d.type === 'user' && 
        d.username !== 'admin' && 
        d.createdBy === currentUser.username
      );
    }

    // Modal Functions
    function showModal(content) {
      document.getElementById('modal-content').innerHTML = content;
      document.getElementById('modal-container').classList.remove('hidden');
    }

    function hideModal() {
      document.getElementById('modal-container').classList.add('hidden');
    }

    // Tab Navigation & Permission Control
    function switchTab(tabName) {
      // Check if user has permission for this tab
      let hasAccess = true;
      if (tabName === 'donors' || tabName === 'sevas' || tabName === 'users') {
        if (!hasPermission('manage_' + tabName)) {
          showToast('You do not have access to this section', 'error');
          return;
        }
      } else if (tabName === 'permissions') {
        if (currentUser.username !== 'admin') {
          showToast('Only superadmin can manage permissions', 'error');
          return;
        }
      } else if (tabName === 'booking' && !hasPermission('booking')) {
        showToast('You do not have access to bookings', 'error');
        return;
      } else if (tabName === 'reports' && !hasPermission('reports')) {
        showToast('You do not have access to reports', 'error');
        return;
      }

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('tab-active');
        if (btn.dataset.tab === tabName) btn.classList.add('tab-active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    }

    function updateUIBasedOnPermissions() {
      const isDonor = currentUser && currentUser.role === 'donor';
      
      // Hide/show tabs based on permissions
      document.getElementById('booking-tab').classList.toggle('hidden', !hasPermission('booking'));
      document.getElementById('reports-tab').classList.toggle('hidden', !hasPermission('reports'));
      document.getElementById('donors-tab').classList.toggle('hidden', !hasPermission('manage_donors') || isDonor);
      document.getElementById('sevas-tab').classList.toggle('hidden', !hasPermission('manage_sevas') || isDonor);
      document.getElementById('users-tab').classList.toggle('hidden', !hasPermission('manage_users') || isDonor);
      document.getElementById('permissions-tab').classList.toggle('hidden', currentUser.username !== 'admin');
      // Donor logins visible to superadmin always, or admins with permission
      document.getElementById('donor-logins-tab').classList.toggle('hidden', !hasPermission('donor_logins') || isDonor);
      // Centers management - superadmin only
      document.getElementById('centers-tab').classList.toggle('hidden', currentUser.username !== 'admin');
      
      // Hide dashboard for donors (they go straight to booking)
      const dashboardTab = document.querySelector('[data-tab="dashboard"]');
      if (dashboardTab) {
        dashboardTab.classList.toggle('hidden', isDonor);
      }
      
      // For donors, switch to booking tab by default
      if (isDonor) {
        switchTab('booking');
      } else if (document.getElementById('permissions-tab').classList.contains('hidden')) {
        switchTab('dashboard');
      }
    }
    
    // Pre-fill donor details when donor logs in
    function prefillDonorDetails() {
      if (!currentUser || currentUser.role !== 'donor' || !currentUser.donorData) return;
      
      const donor = currentUser.donorData;
      
      // Pre-fill booking form with donor details
      document.getElementById('donor-id').value = donor.__backendId;
      document.getElementById('donor-name').value = donor.name || '';
      document.getElementById('donor-spiritual-name').value = donor.spiritualName || '';
      document.getElementById('donor-indian-passport').checked = donor.indianPassport || false;
      document.getElementById('donor-pan').value = donor.pan || '';
      document.getElementById('donor-mobile').value = donor.mobile || '';
      document.getElementById('donor-whatsapp').value = donor.whatsapp || '';
      document.getElementById('donor-email').value = donor.email || '';
      document.getElementById('donor-flat').value = donor.flat || '';
      document.getElementById('donor-road').value = donor.road || '';
      document.getElementById('donor-po').value = donor.po || '';
      document.getElementById('donor-area').value = donor.area || '';
      document.getElementById('donor-pincode').value = donor.pincode || '';
      document.getElementById('donor-district').value = donor.district || '';
      document.getElementById('donor-state').value = donor.state || '';
      document.getElementById('donor-country').value = donor.country || 'India';
      document.getElementById('donor-center').value = donor.centerId || 'center_bangalore';
      
      // Make donor fields read-only for donors
      const donorFields = ['donor-name', 'donor-mobile', 'donor-email'];
      donorFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.readOnly = true;
      });
    }

    // Render Functions
    function renderQuickSevaGrid() {
      const container = document.getElementById('quick-seva-grid');
      const today = new Date().toISOString().split('T')[0];
      
      // Filter sevas that have shortcuts enabled (default is true)
      const shortcutSevas = sevasList.filter(seva => seva.shortcut !== false);
      
      if (shortcutSevas.length === 0) {
        container.innerHTML = '<p class="col-span-2 text-amber-600 text-sm text-center py-4">No shortcuts configured. Go to Manage Sevas to add shortcuts.</p>';
        return;
      }
      
      container.innerHTML = shortcutSevas.map(seva => {
        const cartItem = cart.find(c => c.sevaId === seva.id);
        const isSelected = cartItem && cartItem.quantity > 0;
        const quantity = cartItem ? cartItem.quantity : 0;
        
        return `
          <button type="button" 
            class="quick-seva-btn p-3 rounded-lg border-2 text-left transition-all ${isSelected 
              ? 'border-amber-500 bg-amber-50 shadow-md' 
              : 'border-amber-200 hover:border-amber-400 hover:bg-amber-50'}"
            data-seva-id="${seva.id}">
            <div class="flex justify-between items-start">
              <span class="font-semibold text-amber-900 text-sm leading-tight">${seva.name}</span>
              ${isSelected ? `<span class="bg-amber-500 text-white text-xs px-1.5 py-0.5 rounded-full font-bold">${quantity}</span>` : ''}
            </div>
            <div class="text-amber-700 font-bold text-sm mt-1">‚Çπ${seva.amount}</div>
          </button>
        `;
      }).join('');

      // Add click handlers
      container.querySelectorAll('.quick-seva-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sevaId = btn.dataset.sevaId;
          const seva = sevasList.find(s => s.id === sevaId);
          if (seva) {
            const cartItem = cart.find(c => c.sevaId === seva.id);
            if (cartItem) {
              cartItem.quantity++;
            } else {
              cart.push({ 
                sevaId: seva.id, 
                id: seva.id,
                name: seva.name, 
                description: seva.description, 
                amount: seva.amount, 
                quantity: 1,
                bookingDate: today
              });
            }
            renderQuickSevaGrid();
            renderSlidingSevaList();
            renderSelectedSevasList();
            renderCart();
            showToast(`Added ${seva.name}`);
          }
        });
      });
    }

    function renderSlidingSevaList() {
      const container = document.getElementById('sliding-seva-list');

      container.innerHTML = sevasList.map(seva => {
        const cartItem = cart.find(c => c.sevaId === seva.id);
        const quantity = cartItem ? cartItem.quantity : 0;
        const bookingDate = cartItem ? cartItem.bookingDate : '';
        
        return `
          <div class="border-2 ${quantity > 0 ? 'border-amber-500 bg-amber-50' : 'border-amber-200'} rounded-lg p-3 transition hover:border-amber-400" data-seva-id="${seva.id}">
            <div class="flex justify-between items-start mb-2">
              <div class="flex-1">
                <h4 class="font-semibold text-amber-900">${seva.name}</h4>
                <p class="text-xs text-amber-600">${seva.description}</p>
              </div>
              <span class="font-bold text-amber-800 text-sm">‚Çπ${seva.amount}</span>
            </div>
            <div class="space-y-2 mt-3 pt-3 border-t border-amber-200">
              <div>
                <label class="text-xs text-amber-700 font-semibold block mb-1">Booking Date</label>
                <input type="date" class="seva-date-picker w-full px-2 py-1 border border-amber-300 rounded text-xs" data-seva-id="${seva.id}" value="${bookingDate}">
              </div>
              <div class="flex items-center justify-between gap-2">
                <span class="text-xs font-semibold text-amber-900">
                  ${quantity > 0 ? `${quantity} Selected` : 'Click to Add'}
                </span>
                <div class="flex gap-1 items-center">
                  ${quantity > 0 ? `
                    <button type="button" class="minus-seva-btn bg-amber-300 hover:bg-amber-400 text-amber-900 px-2 py-1 rounded text-sm font-bold transition" data-seva-id="${seva.id}" title="Decrease quantity">&minus;</button>
                  ` : ''}
                  <button type="button" class="click-seva-btn bg-gradient-to-r from-amber-400 to-amber-500 hover:from-amber-500 hover:to-amber-600 text-white px-3 py-1 rounded text-sm font-bold transition" data-seva-id="${seva.id}">
                    ${quantity > 0 ? '+' : 'Add'}
                  </button>
                  ${quantity > 0 ? `
                    <button type="button" class="remove-seva-btn text-red-600 hover:text-red-800 transition p-1" data-seva-id="${seva.id}" title="Remove from cart">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 3a1 1 0 00-1 1v1H5a1 1 0 000 2h1v12a2 2 0 002 2h8a2 2 0 002-2V7h1a1 1 0 100-2h-3V4a1 1 0 00-1-1h-4zm0 2h6v13H9V5zm1 2a1 1 0 100 2h4a1 1 0 100-2h-4zm0 3a1 1 0 100 2h4a1 1 0 100-2h-4zm0 3a1 1 0 100 2h4a1 1 0 100-2h-4z"/>
                      </svg>
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      const today = new Date().toISOString().split('T')[0];

      container.querySelectorAll('.click-seva-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sevaId = btn.dataset.sevaId;
          const seva = sevasList.find(s => s.id === sevaId);
          if (seva) {
            const cartItem = cart.find(c => c.sevaId === seva.id);
            if (cartItem) {
              cartItem.quantity++;
            } else {
              cart.push({ 
                sevaId: seva.id, 
                id: seva.id,
                name: seva.name, 
                description: seva.description, 
                amount: seva.amount, 
                quantity: 1,
                bookingDate: today
              });
            }
            renderSlidingSevaList();
            renderQuickSevaGrid();
            renderSelectedSevasList();
            renderCart();
          }
        });
      });

      container.querySelectorAll('.minus-seva-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sevaId = btn.dataset.sevaId;
          const item = cart.find(c => c.sevaId === sevaId);
          if (item && item.quantity > 1) {
            item.quantity--;
            renderSlidingSevaList();
            renderQuickSevaGrid();
            renderSelectedSevasList();
            renderCart();
          }
        });
      });

      container.querySelectorAll('.remove-seva-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sevaId = btn.dataset.sevaId;
          cart = cart.filter(c => c.sevaId !== sevaId);
          renderSlidingSevaList();
          renderQuickSevaGrid();
          renderSelectedSevasList();
          renderCart();
        });
      });

      container.querySelectorAll('.seva-date-picker').forEach(input => {
        input.setAttribute('min', today);
        input.addEventListener('change', () => {
          const sevaId = input.dataset.sevaId;
          const item = cart.find(c => c.sevaId === sevaId);
          if (item) {
            item.bookingDate = input.value;
            renderSelectedSevasList();
            renderCart();
          }
        });
      });
    }

    function renderSelectedSevasList() {
      const container = document.getElementById('seva-list');
      
      if (cart.length === 0) {
        container.innerHTML = '<p class="text-amber-600 text-sm">No sevas selected yet</p>';
        return;
      }

      container.innerHTML = cart.map(item => {
        const sevaDate = item.bookingDate ? new Date(item.bookingDate).toLocaleDateString('en-GB') : 'N/A';
        return `
          <div class="border border-amber-300 rounded-lg p-3 bg-amber-50">
            <div class="flex justify-between items-start mb-2">
              <div>
                <h4 class="font-semibold text-amber-900">${item.name}</h4>
                <p class="text-xs text-amber-600">Date: ${sevaDate}</p>
              </div>
              <span class="text-sm font-semibold text-amber-800">Qty: ${item.quantity}</span>
            </div>
            <div class="flex items-center gap-2 pt-2 border-t border-amber-200">
              <button type="button" class="decrease-item-btn text-xs bg-amber-300 hover:bg-amber-400 text-amber-900 px-2 py-1 rounded font-bold" data-seva-id="${item.sevaId}">&minus;</button>
              <span class="text-xs text-amber-700 flex-1">‚Çπ${(item.amount * item.quantity).toLocaleString()}</span>
              <button type="button" class="increase-item-btn text-xs bg-amber-500 hover:bg-amber-600 text-white px-2 py-1 rounded font-bold" data-seva-id="${item.sevaId}">+</button>
              <button type="button" class="remove-selected-btn text-red-600 hover:text-red-800 ml-2" data-seva-id="${item.sevaId}">√ó</button>
            </div>
          </div>
        `;
      }).join('');

      container.querySelectorAll('.increase-item-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sevaId = btn.dataset.sevaId;
          const item = cart.find(c => c.sevaId === sevaId);
          if (item) {
            item.quantity++;
            renderSelectedSevasList();
            renderQuickSevaGrid();
            renderCart();
          }
        });
      });

      container.querySelectorAll('.decrease-item-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sevaId = btn.dataset.sevaId;
          const item = cart.find(c => c.sevaId === sevaId);
          if (item && item.quantity > 1) {
            item.quantity--;
            renderSelectedSevasList();
            renderQuickSevaGrid();
            renderCart();
          }
        });
      });

      container.querySelectorAll('.remove-selected-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sevaId = btn.dataset.sevaId;
          cart = cart.filter(item => item.sevaId !== sevaId);
          renderSelectedSevasList();
          renderQuickSevaGrid();
          renderSlidingSevaList();
          renderCart();
        });
      });
    }

    function renderCart() {
      const container = document.getElementById('cart-items');
      const totalEl = document.getElementById('total-amount');
      
      if (cart.length === 0) {
        container.innerHTML = '<p class="text-amber-600 text-sm">No sevas selected</p>';
        totalEl.textContent = '0';
        return;
      }

      container.innerHTML = cart.map(item => {
        const sevaDate = item.bookingDate ? new Date(item.bookingDate).toLocaleDateString('en-GB') : 'N/A';
        return `
          <div class="flex justify-between items-center text-sm py-2 border-b border-amber-100">
            <div class="flex-1">
              <span class="text-amber-800">${item.name}</span>
              <span class="text-xs text-amber-600 ml-2">(Qty: ${item.quantity})</span>
              <div class="text-xs text-amber-600 mt-0.5">Date: ${sevaDate}</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-amber-900 font-medium">‚Çπ${(item.amount * item.quantity).toLocaleString()}</span>
              <button type="button" class="text-red-600 hover:text-red-800 ml-2 remove-item-btn" data-seva-id="${item.sevaId}">√ó</button>
            </div>
          </div>
        `;
      }).join('');

      container.querySelectorAll('.remove-item-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const sevaId = btn.dataset.sevaId;
          cart = cart.filter(item => item.sevaId !== sevaId);
          renderCart();
          renderQuickSevaGrid();
          renderSlidingSevaList();
          renderSelectedSevasList();
        });
      });

      const total = cart.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
      totalEl.textContent = `‚Çπ${total.toLocaleString()}`;
    }

    function renderPermissionsPage() {
      const container = document.getElementById('permissions-container');
      const managedUsers = getUsers().filter(u => u.username !== 'admin');

      if (managedUsers.length === 0) {
        container.innerHTML = '<p class="text-center text-amber-600 py-8">No users found. Create admins or volunteers first to manage their permissions.</p>';
        return;
      }

      let html = `
        <div class="overflow-x-auto border border-amber-300 rounded-lg">
          <table class="w-full border-collapse bg-white">
            <thead>
              <tr class="bg-amber-100 border-b-2 border-amber-300">
                <th class="px-6 py-4 text-left font-semibold text-amber-900 border-r border-amber-300 min-w-max">User</th>
      `;

      allPermissions.forEach(perm => {
        html += `<th class="px-4 py-4 text-center font-semibold text-amber-900 border-r border-amber-300 min-w-max">${perm.label}</th>`;
      });

      html += `
              </tr>
            </thead>
            <tbody>
      `;

      managedUsers.forEach((user, idx) => {
        const perms = getUserPermissions(user);
        const rowBg = idx % 2 === 0 ? 'bg-white' : 'bg-amber-50';
        const roleColor = user.role === 'admin' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700';
        
        html += `
              <tr class="${rowBg} border-b border-amber-200 hover:bg-amber-100 transition">
                <td class="px-6 py-4 font-medium text-amber-900 border-r border-amber-300">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="w-8 h-8 flex items-center justify-center bg-amber-200 rounded-full text-sm font-bold text-amber-700">${user.username.charAt(0).toUpperCase()}</span>
                    <div>
                      <div>${user.username}</div>
                      <span class="text-xs px-2 py-0.5 rounded-full ${roleColor}">${user.role}</span>
                    </div>
                  </div>
                </td>
        `;

        allPermissions.forEach(perm => {
          html += `
                <td class="px-4 py-4 text-center border-r border-amber-300">
                  <input type="checkbox" class="permission-checkbox permission-${user.__backendId}-${perm.id}" ${perms[perm.id] ? 'checked' : ''} data-user-id="${user.__backendId}" data-permission="${perm.id}" style="width:20px; height:20px; cursor:pointer;">
                </td>
          `;
        });

        html += `
              </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;

      container.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', async () => {
          const userId = checkbox.dataset.userId;
          const permissionId = checkbox.dataset.permission;
          const user = getUsers().find(u => u.__backendId === userId);

          if (user) {
            let perms = getUserPermissions(user);
            perms[permissionId] = checkbox.checked;
            
            const updatedUser = {
              ...user,
              permissions: JSON.stringify(perms)
            };

            const result = await window.dataSdk.update(updatedUser);
            if (result.isOk) {
              showToast(`Permission updated for ${user.username}`);
            } else {
              showToast('Failed to update permissions', 'error');
              checkbox.checked = !checkbox.checked;
            }
          }
        });
      });
    }

    function renderDonorsTable() {
      const donors = getDonors();
      const bookings = getBookings();
      const tbody = document.getElementById('donors-table-body');
      const noData = document.getElementById('no-donors');

      if (donors.length === 0) {
        tbody.innerHTML = '';
        noData.classList.remove('hidden');
        return;
      }

      noData.classList.add('hidden');
      tbody.innerHTML = donors.map((d, index) => {
        // Calculate stats for this donor
        const donorBookings = bookings.filter(b => b.donorId === d.__backendId);
        const totalDonations = donorBookings.reduce((sum, b) => {
          const items = b.items ? JSON.parse(b.items) : [];
          return sum + items.reduce((s, item) => s + (item.amount * item.quantity), 0);
        }, 0);
        
        // Get last donation date
        const lastDonation = donorBookings.length > 0 
          ? new Date(Math.max(...donorBookings.map(b => new Date(b.bookingDate)))).toLocaleDateString('en-GB')
          : '-';
        
        // Build short address
        const shortAddress = [d.area, d.district, d.pincode].filter(Boolean).join(', ') || '-';
        
        return `
          <tr class="border-b border-amber-100 hover:bg-amber-50">
            <td class="py-3 px-4 text-amber-600 text-sm">${index + 1}</td>
            <td class="py-3 px-4">
              <div class="text-amber-900 font-medium">${d.name}</div>
              ${d.spiritualName ? `<div class="text-xs text-amber-600 italic">${d.spiritualName}</div>` : ''}
            </td>
            <td class="py-3 px-4 text-amber-700">${d.mobile || '-'}</td>
            <td class="py-3 px-4 text-amber-700">${d.whatsapp || '-'}</td>
            <td class="py-3 px-4 text-amber-700 text-sm">${d.email || '-'}</td>
            <td class="py-3 px-4 text-amber-700 text-xs max-w-xs truncate" title="${shortAddress}">${shortAddress}</td>
            <td class="py-3 px-4 text-center">
              <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700 font-medium">${donorBookings.length}</span>
            </td>
            <td class="py-3 px-4 text-amber-900 font-semibold">‚Çπ${totalDonations.toLocaleString()}</td>
            <td class="py-3 px-4 text-amber-700 text-sm">${lastDonation}</td>
            <td class="py-3 px-4">
              <div class="flex gap-2">
                <button class="text-blue-600 hover:text-blue-800 font-medium text-xs view-donor-btn" data-donor-id="${d.__backendId}" title="View details">View</button>
                <button class="text-amber-600 hover:text-amber-800 font-medium text-xs edit-donor-btn" data-donor-id="${d.__backendId}" title="Edit details">Edit</button>
                <button class="text-green-600 hover:text-green-800 font-medium text-xs select-donor-btn" data-donor-id="${d.__backendId}" title="Select for booking">Use</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('.select-donor-btn').forEach(btn => {
        btn.addEventListener('click', () => selectDonor(btn.dataset.donorId));
      });

      tbody.querySelectorAll('.view-donor-btn').forEach(btn => {
        btn.addEventListener('click', () => showDonorDetailsModal(btn.dataset.donorId));
      });

      tbody.querySelectorAll('.edit-donor-btn').forEach(btn => {
        btn.addEventListener('click', () => showEditDonorModal(btn.dataset.donorId));
      });
    }

    function getCenterName(centerId) {
      const centerMap = {
        'center_bangalore': 'Bangalore',
        'center_delhi': 'Delhi',
        'center_mumbai': 'Mumbai',
        'center_chennai': 'Chennai',
        'center_kolkata': 'Kolkata',
        'all_centers': 'All Centers',
        'All Centers': 'All Centers',
        '': 'All Centers'
      };
      return centerMap[centerId] || (centerId ? centerId : 'All Centers');
    }
    
    function getCollectorDisplayName(username) {
      const nameMap = {
        'admin': 'Superadmin',
        'admin1': 'Admin 1',
        'admin2': 'Admin 2',
        'volunteer1': 'Volunteer 1'
      };
      return nameMap[username] || username;
    }

    function renderUsersTable() {
      const users = getUsers();
      const centerFilter = document.getElementById('users-center-filter').value;
      const tbody = document.getElementById('users-table-body');

      const filteredUsers = centerFilter 
        ? users.filter(u => u.centerId === centerFilter)
        : users;

      tbody.innerHTML = filteredUsers.map(u => `
        <tr class="border-b border-amber-100 hover:bg-amber-50">
          <td class="py-3 px-4">
            <div class="text-amber-900 font-medium">${u.username}</div>
            <div class="text-xs text-amber-600 mt-1">ID: ${u.__backendId.substring(0, 8)}...</div>
          </td>
          <td class="py-3 px-4">
            <span class="px-2 py-1 text-xs rounded-full font-medium ${u.username === 'admin' ? 'bg-red-100 text-red-700' : u.role === 'admin' ? 'bg-orange-100 text-orange-700' : u.role === 'volunteer' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${u.username === 'admin' ? 'Superadmin' : u.role.charAt(0).toUpperCase() + u.role.slice(1)}</span>
          </td>
          <td class="py-3 px-4">
            <div class="text-amber-700 text-sm font-medium">${getCenterName(u.centerId)}</div>
            <div class="text-xs text-amber-600 mt-1">${u.centerId || 'All Centers'}</div>
          </td>
          <td class="py-3 px-4">
            ${u.username !== 'admin' ? `
              <button class="text-red-600 hover:text-red-800 font-medium text-sm delete-user-btn" data-user-id="${u.__backendId}">Delete</button>
            ` : '<span class="text-amber-400 text-xs font-semibold">Protected</span>'}
          </td>
        </tr>
      `).join('');

      if (filteredUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-amber-600">No users found for this center</td></tr>';
      }

      tbody.querySelectorAll('.delete-user-btn').forEach(btn => {
        btn.addEventListener('click', () => confirmDeleteUser(btn.dataset.userId));
      });
    }

    function renderSevasGrid() {
      const container = document.getElementById('sevas-grid');
      const noData = document.getElementById('no-sevas');

      if (sevasList.length === 0) {
        container.innerHTML = '';
        noData.classList.remove('hidden');
        return;
      }

      noData.classList.add('hidden');
      container.innerHTML = sevasList.map(s => {
        const hasShortcut = s.shortcut !== false; // Default to true if not set
        return `
        <div class="border border-amber-200 rounded-xl p-4 hover:shadow-md transition ${hasShortcut ? 'ring-2 ring-amber-400' : ''}">
          <div class="flex justify-between items-start mb-2">
            <h4 class="font-semibold text-amber-900">${s.name}</h4>
            <span class="font-bold text-amber-700">‚Çπ${s.amount}</span>
          </div>
          <p class="text-sm text-amber-600 mb-3">${s.description}</p>
          <div class="flex items-center justify-between">
            <div class="flex gap-2">
              <button class="text-xs text-blue-600 hover:text-blue-800 edit-seva-btn" data-seva-id="${s.id}">Edit</button>
              <button class="text-xs text-red-600 hover:text-red-800 delete-seva-btn" data-seva-id="${s.id}">Delete</button>
            </div>
            <button class="shortcut-toggle-btn flex items-center gap-1 text-xs px-2 py-1 rounded-full transition-all ${hasShortcut 
              ? 'bg-amber-500 text-white hover:bg-amber-600' 
              : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}" 
              data-seva-id="${s.id}" title="${hasShortcut ? 'Remove from shortcuts' : 'Add to shortcuts'}">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              ${hasShortcut ? 'Shortcut ON' : 'Shortcut OFF'}
            </button>
          </div>
        </div>
      `}).join('');

      container.querySelectorAll('.edit-seva-btn').forEach(btn => {
        btn.addEventListener('click', () => showEditSevaModal(btn.dataset.sevaId));
      });

      container.querySelectorAll('.delete-seva-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.sevaId;
          sevasList = sevasList.filter(s => s.id !== id);
          saveSevas();
          renderSevasGrid();
          renderSlidingSevaList();
          renderQuickSevaGrid();
          showToast('Seva deleted');
        });
      });

      container.querySelectorAll('.shortcut-toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.sevaId;
          const seva = sevasList.find(s => s.id === id);
          if (seva) {
            seva.shortcut = seva.shortcut === false ? true : false;
            saveSevas();
            renderSevasGrid();
            renderQuickSevaGrid();
            showToast(seva.shortcut ? `${seva.name} added to shortcuts` : `${seva.name} removed from shortcuts`);
          }
        });
      });
    }

    function renderDonorLoginsTable() {
      const tbody = document.getElementById('donor-logins-table-body');
      const noData = document.getElementById('no-donor-logins');
      const filterDiv = document.getElementById('donor-logins-filter');
      const centerFilter = document.getElementById('donor-logins-center-filter');
      const searchInput = document.getElementById('donor-logins-search');
      
      if (!tbody) return;
      
      // Only users with donor_logins permission can see this
      if (!currentUser || !hasPermission('donor_logins')) {
        tbody.innerHTML = '';
        if (noData) noData.classList.remove('hidden');
        if (filterDiv) filterDiv.classList.add('hidden');
        return;
      }
      
      // Show filter for all users with donor_logins permission
      if (filterDiv) {
        filterDiv.classList.remove('hidden');
      }
      
      // Get donors based on user role
      let donors = getDonors();
      const bookings = allData.filter(d => d.type === 'booking');
      
      // Apply center filter
      if (centerFilter && centerFilter.value) {
        donors = donors.filter(d => d.centerId === centerFilter.value);
      }
      
      // Apply search filter
      if (searchInput && searchInput.value.trim()) {
        const searchTerm = searchInput.value.trim().toLowerCase();
        donors = donors.filter(d => 
          (d.name && d.name.toLowerCase().includes(searchTerm)) ||
          (d.spiritualName && d.spiritualName.toLowerCase().includes(searchTerm)) ||
          (d.mobile && d.mobile.includes(searchTerm))
        );
      }
      
      if (donors.length === 0) {
        tbody.innerHTML = '';
        if (noData) noData.classList.remove('hidden');
        return;
      }
      
      if (noData) noData.classList.add('hidden');
      
      // Get center name helper
      const getCenterLabel = (centerId) => {
        const centers = { 'center_bangalore': 'Bangalore', 'center_delhi': 'Delhi' };
        return centers[centerId] || centerId || '-';
      };
      
      tbody.innerHTML = donors.map((d, index) => {
        // Count donations for this donor
        const donorBookings = bookings.filter(b => b.donorId === d.__backendId);
        const totalAmount = donorBookings.reduce((sum, b) => {
          const items = b.items ? JSON.parse(b.items) : [];
          return sum + items.reduce((s, item) => s + (item.amount * item.quantity), 0);
        }, 0);
        
        return `
          <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-amber-50'} hover:bg-amber-100 transition">
            <td class="py-3 px-4 text-amber-600 text-sm">${index + 1}</td>
            <td class="py-3 px-4">
              <div class="text-amber-900 font-medium">${d.name}</div>
              <div class="text-xs text-amber-500">${getCenterLabel(d.centerId)}</div>
            </td>
            <td class="py-3 px-4 text-amber-700 text-sm">${d.spiritualName || '-'}</td>
            <td class="py-3 px-4 text-amber-700 text-sm">${d.mobile || '-'}</td>
            <td class="py-3 px-4">
              <code class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-mono">${d.name}</code>
            </td>
            <td class="py-3 px-4">
              <code class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-mono">${d.name}</code>
            </td>
            <td class="py-3 px-4">
              <div class="text-amber-900 font-medium">${donorBookings.length} bookings</div>
              <div class="text-xs text-amber-600">‚Çπ${totalAmount.toLocaleString()}</div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderCentersTable() {
      const tbody = document.getElementById('centers-table-body');
      const noData = document.getElementById('no-centers');
      
      if (!tbody) return;
      
      if (centersList.length === 0) {
        tbody.innerHTML = '';
        if (noData) noData.classList.remove('hidden');
        return;
      }
      
      if (noData) noData.classList.add('hidden');
      
      tbody.innerHTML = centersList.map((center, index) => {
        // Count donors and users for this center
        const donorCount = allData.filter(d => d.type === 'donor' && d.centerId === center.id).length;
        const userCount = allData.filter(d => d.type === 'user' && d.centerId === center.id).length;
        
        return `
          <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-amber-50'} hover:bg-amber-100 transition">
            <td class="py-3 px-4 text-amber-600 text-sm">${index + 1}</td>
            <td class="py-3 px-4">
              <code class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-mono">${center.id}</code>
            </td>
            <td class="py-3 px-4">
              <div class="text-amber-900 font-medium">${center.name}</div>
            </td>
            <td class="py-3 px-4 text-amber-700">${center.city || '-'}</td>
            <td class="py-3 px-4 text-amber-700">${center.state || '-'}</td>
            <td class="py-3 px-4">
              <div class="text-amber-900">${donorCount} donors</div>
              <div class="text-xs text-amber-600">${userCount} users</div>
            </td>
            <td class="py-3 px-4">
              <div class="flex gap-2">
                <button class="edit-center-btn text-blue-600 hover:text-blue-800 text-sm" data-center-id="${center.id}">Edit</button>
                <button class="delete-center-btn text-red-600 hover:text-red-800 text-sm" data-center-id="${center.id}">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      // Attach event listeners
      tbody.querySelectorAll('.edit-center-btn').forEach(btn => {
        btn.addEventListener('click', () => openEditCenterModal(btn.dataset.centerId));
      });
      
      tbody.querySelectorAll('.delete-center-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteCenter(btn.dataset.centerId));
      });
    }

    function openAddCenterModal() {
      showModal(`
        <h3 class="font-display text-xl font-semibold text-amber-900 mb-4">Add New Center</h3>
        <form id="add-center-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Center Name *</label>
            <input type="text" id="new-center-name" required class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Hyderabad Center">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Center ID</label>
            <input type="text" id="new-center-id" required class="w-full px-3 py-2 border border-amber-200 rounded-lg bg-amber-50 outline-none" readonly placeholder="Auto-generated from name">
            <p class="text-xs text-amber-500 mt-1">Auto-generated from center name</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-amber-700 mb-1">City</label>
              <input type="text" id="new-center-city" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Hyderabad">
            </div>
            <div>
              <label class="block text-sm font-medium text-amber-700 mb-1">State</label>
              <input type="text" id="new-center-state" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Telangana">
            </div>
          </div>
          <div class="flex gap-3 pt-4 border-t border-amber-200">
            <button type="button" onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
            <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg">Add Center</button>
          </div>
        </form>
      `);
      
      // Auto-populate Center ID from Center Name
      document.getElementById('new-center-name').addEventListener('input', (e) => {
        const name = e.target.value.trim();
        // Generate ID: "center_" + lowercase name with spaces replaced by underscores, remove special chars
        const id = 'center_' + name.toLowerCase()
          .replace(/\s+center$/i, '') // Remove "Center" suffix if present
          .replace(/[^a-z0-9\s]/g, '') // Remove special characters
          .replace(/\s+/g, '_'); // Replace spaces with underscores
        document.getElementById('new-center-id').value = id;
      });
      
      document.getElementById('add-center-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const id = document.getElementById('new-center-id').value.trim().toLowerCase().replace(/\s+/g, '_');
        const name = document.getElementById('new-center-name').value.trim();
        const city = document.getElementById('new-center-city').value.trim();
        const state = document.getElementById('new-center-state').value.trim();
        
        // Check for duplicate ID
        if (centersList.some(c => c.id === id)) {
          showToast('A center with this ID already exists', 'error');
          return;
        }
        
        centersList.push({ id, name, city, state });
        saveCenters();
        hideModal();
        renderCentersTable();
        populateAllCenterDropdowns();
        showToast('Center added successfully');
      });
    }

    function openEditCenterModal(centerId) {
      const center = centersList.find(c => c.id === centerId);
      if (!center) return;
      
      showModal(`
        <h3 class="font-display text-xl font-semibold text-amber-900 mb-4">Edit Center</h3>
        <form id="edit-center-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Center ID</label>
            <input type="text" value="${center.id}" class="w-full px-3 py-2 border border-amber-200 rounded-lg bg-amber-50 outline-none" readonly>
            <p class="text-xs text-amber-500 mt-1">Center ID cannot be changed</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Center Name *</label>
            <input type="text" id="edit-center-name" required value="${center.name}" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-amber-700 mb-1">City</label>
              <input type="text" id="edit-center-city" value="${center.city || ''}" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-amber-700 mb-1">State</label>
              <input type="text" id="edit-center-state" value="${center.state || ''}" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
          </div>
          <div class="flex gap-3 pt-4 border-t border-amber-200">
            <button type="button" onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
            <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg">Save Changes</button>
          </div>
        </form>
      `);
      
      document.getElementById('edit-center-form').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const idx = centersList.findIndex(c => c.id === centerId);
        if (idx !== -1) {
          centersList[idx].name = document.getElementById('edit-center-name').value.trim();
          centersList[idx].city = document.getElementById('edit-center-city').value.trim();
          centersList[idx].state = document.getElementById('edit-center-state').value.trim();
          saveCenters();
          hideModal();
          renderCentersTable();
          populateAllCenterDropdowns();
          showToast('Center updated successfully');
        }
      });
    }

    function deleteCenter(centerId) {
      const center = centersList.find(c => c.id === centerId);
      if (!center) return;
      
      // Check if center has donors or users
      const donorCount = allData.filter(d => d.type === 'donor' && d.centerId === centerId).length;
      const userCount = allData.filter(d => d.type === 'user' && d.centerId === centerId).length;
      
      if (donorCount > 0 || userCount > 0) {
        showModal(`
          <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
              <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <h3 class="font-display text-xl font-semibold text-amber-900 mb-2">Cannot Delete Center</h3>
            <p class="text-amber-700 mb-4">This center has ${donorCount} donors and ${userCount} users assigned to it.</p>
            <p class="text-sm text-amber-600 mb-4">Please reassign or remove all donors and users before deleting this center.</p>
            <button onclick="hideModal()" class="w-full btn-primary text-white py-2 rounded-lg">OK</button>
          </div>
        `);
        return;
      }
      
      showModal(`
        <div class="text-center">
          <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </div>
          <h3 class="font-display text-xl font-semibold text-amber-900 mb-2">Delete Center?</h3>
          <p class="text-amber-700 mb-4">Are you sure you want to delete <strong>${center.name}</strong>?</p>
          <div class="flex gap-3">
            <button onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
            <button onclick="confirmDeleteCenter('${centerId}')" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Delete</button>
          </div>
        </div>
      `);
    }

    function confirmDeleteCenter(centerId) {
      centersList = centersList.filter(c => c.id !== centerId);
      saveCenters();
      hideModal();
      renderCentersTable();
      populateAllCenterDropdowns();
      showToast('Center deleted successfully');
    }

    function populateAllCenterDropdowns() {
      // Get all center dropdown selects
      const dropdowns = [
        'donor-center',
        'modal-donor-center', 
        'edit-modal-donor-center',
        'donor-logins-center-filter'
      ];
      
      dropdowns.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
          const currentValue = select.value;
          const isFilter = id.includes('filter');
          
          select.innerHTML = isFilter ? '<option value="">All Centers</option>' : '';
          
          centersList.forEach(center => {
            const option = document.createElement('option');
            option.value = center.id;
            option.textContent = center.name;
            if (center.id === currentValue) option.selected = true;
            select.appendChild(option);
          });
          
          // Set default for non-filter dropdowns if no value selected
          if (!isFilter && !currentValue && currentUser) {
            select.value = currentUser.centerId || centersList[0]?.id || '';
          }
        }
      });
    }

    function renderReportsTable() {
      const bookings = getFilteredReportBookings();
      const donors = getDonors();
      const tbody = document.getElementById('reports-table-body');
      const noData = document.getElementById('no-reports');

      if (bookings.length === 0) {
        tbody.innerHTML = '';
        noData.classList.remove('hidden');
        return;
      }

      noData.classList.add('hidden');
      tbody.innerHTML = bookings.map(b => {
        const donor = allData.find(d => d.__backendId === b.donorId);
        const items = b.items ? JSON.parse(b.items) : [];
        const sevaDetails = items.map(i => `${i.name} (Qty: ${i.quantity})`).join(', ');
        const donorName = donor ? donor.name || 'Unknown' : 'Unknown';
        
        const correctTotal = items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
        
        // Get collected by info
        const collectedByUsername = b.collectedBy || 'Unknown';
        const collectedByDisplay = getCollectorDisplayName(collectedByUsername);
        const centerName = getCenterName(b.collectedByCenter || b.centerId);
        
        // Color coding for different collectors
        const collectorColors = {
          'admin': 'bg-red-100 text-red-700',
          'admin1': 'bg-blue-100 text-blue-700',
          'admin2': 'bg-purple-100 text-purple-700',
          'volunteer1': 'bg-green-100 text-green-700'
        };
        const collectorColor = collectorColors[collectedByUsername] || 'bg-gray-100 text-gray-700';
        
        return `
          <tr class="border-b border-amber-100 hover:bg-amber-50">
            <td class="py-3 px-4 text-amber-700">${new Date(b.bookingDate).toLocaleDateString('en-GB')}</td>
            <td class="py-3 px-4 text-amber-900">${donorName}</td>
            <td class="py-3 px-4 text-amber-700 text-sm">${sevaDetails}</td>
            <td class="py-3 px-4 text-amber-900 font-medium">‚Çπ${correctTotal.toLocaleString()}</td>
            <td class="py-3 px-4">
              <span class="px-2 py-1 text-xs rounded-full font-medium ${collectorColor}">${collectedByDisplay}</span>
            </td>
            <td class="py-3 px-4 text-amber-700 text-sm">${centerName}</td>
            <td class="py-3 px-4">
              <span class="px-2 py-1 text-xs rounded-full ${b.paymentStatus === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${b.paymentStatus || 'pending'}</span>
            </td>
            <td class="py-3 px-4">
              ${hasPermission('receipts') ? `<button class="text-amber-600 hover:text-amber-800 font-medium text-sm download-receipt-btn" data-booking-id="${b.__backendId}" data-donor-id="${b.donorId}">Download</button>` : '<span class="text-gray-400 text-sm">N/A</span>'}
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('.download-receipt-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const bookingId = btn.dataset.bookingId;
          const donorId = btn.dataset.donorId;
          generateReceipts(bookingId, donorId);
        });
      });
    }

    // Populate the collector filter dropdown based on user hierarchy
    function populateCollectorFilter() {
      const select = document.getElementById('report-collector-filter');
      if (!select) return;
      
      // Keep the first option
      select.innerHTML = '<option value="">All Collectors</option>';
      
      // Get users that current user can see
      const users = getCenterUsers();
      
      // For superadmin, also add themselves
      if (currentUser && currentUser.role === 'superadmin') {
        select.innerHTML += `<option value="admin">Superadmin (Me)</option>`;
      }
      
      // Add current user if not superadmin
      if (currentUser && currentUser.role !== 'superadmin') {
        select.innerHTML += `<option value="${currentUser.username}">${currentUser.username} (Me)</option>`;
      }
      
      // Add other users
      users.forEach(user => {
        if (user.username !== currentUser.username) {
          const roleLabel = user.role === 'admin' ? 'Admin' : 'Volunteer';
          select.innerHTML += `<option value="${user.username}">${user.username} (${roleLabel})</option>`;
        }
      });
    }

    function getFilteredReportBookings() {
      const bookings = getBookings();
      const statusFilter = document.getElementById('report-status-filter').value;
      const collectorFilter = document.getElementById('report-collector-filter').value;
      const dateFilter = document.getElementById('report-date-filter').value;
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;

      return bookings.filter(b => {
        if (statusFilter && b.paymentStatus !== statusFilter) return false;
        
        // Filter by collector
        if (collectorFilter && b.collectedBy !== collectorFilter) return false;

        const bookingDate = new Date(b.bookingDate);
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay());
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const startOfYear = new Date(today.getFullYear(), 0, 1);

        if (dateFilter === 'today') {
          if (bookingDate.toDateString() !== today.toDateString()) return false;
        } else if (dateFilter === 'week') {
          if (bookingDate < startOfWeek) return false;
        } else if (dateFilter === 'month') {
          if (bookingDate < startOfMonth) return false;
        } else if (dateFilter === 'year') {
          if (bookingDate < startOfYear) return false;
        }

        if (startDate && bookingDate < new Date(startDate)) return false;
        if (endDate && bookingDate > new Date(endDate + 'T23:59:59')) return false;

        return true;
      });
    }

    function getQRCodeDataURL(text, size) {
      size = size || 100;
      try {
        if (typeof QRCode === 'undefined') return '';
        const div = document.createElement('div');
        div.style.cssText = 'position:absolute;left:-9999px;top:0;';
        document.body.appendChild(div);
        new QRCode(div, { text: text, width: size, height: size });
        const canvas = div.querySelector('canvas');
        const img = div.querySelector('img');
        let dataUrl = '';
        if (canvas) {
          dataUrl = canvas.toDataURL('image/png');
        } else if (img && img.src) {
          dataUrl = img.src;
        }
        document.body.removeChild(div);
        return dataUrl;
      } catch (e) {
        return '';
      }
    }

    function generateReceipts(bookingId, donorId) {
      const booking = getBookings().find(b => b.__backendId === bookingId);
      
      if (!booking) {
        showToast('Booking not found', 'error');
        return;
      }

      let donor = allData.find(d => d.__backendId === donorId);

      if (!donor) {
        showToast('Donor not found - please check the booking details', 'error');
        return;
      }

      const items = booking.items ? JSON.parse(booking.items) : [];
      
      if (items.length === 0) {
        showToast('No sevas in this booking', 'error');
        return;
      }

      const hasFestivalQR = booking.festivalQR === true || booking.festivalQR === 'true';

      let allReceiptsHTML = '<div style="margin:0;padding:0;">';

      items.forEach((item, index) => {
        const receiptNumber = `RCP-${booking.__backendId.substring(0, 8)}-${index + 1}`;
        const transactionDate = new Date(booking.bookingDate).toLocaleDateString('en-GB', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const totalForSeva = item.amount * item.quantity;

        let qrSectionHTML = '';
        if (hasFestivalQR) {
          const payloadDarshan = `${booking.__backendId}|${index}|darshan`;
          const payloadPrasadam = `${booking.__backendId}|${index}|prasadam`;
          const qrDarshan = getQRCodeDataURL(payloadDarshan, 90);
          const qrPrasadam = getQRCodeDataURL(payloadPrasadam, 90);
          qrSectionHTML = `
            <div style="display:flex;justify-content:center;gap:24px;margin:12px 0;flex-shrink:0;">
              <div style="text-align:center;">
                <p style="margin:0 0 4px 0;font-size:10px;font-weight:bold;color:#5a3600;">Darshan</p>
                <img src="${qrDarshan}" alt="Darshan QR" style="width:90px;height:90px;display:block;border:1px solid #c9a24d;border-radius:4px;">
              </div>
              <div style="text-align:center;">
                <p style="margin:0 0 4px 0;font-size:10px;font-weight:bold;color:#5a3600;">Prasadam</p>
                <img src="${qrPrasadam}" alt="Prasadam QR" style="width:90px;height:90px;display:block;border:1px solid #c9a24d;border-radius:4px;">
              </div>
            </div>
          `;
        }

        const receiptHTML = `
          <div style="width:210mm;height:148mm;margin:8px auto;padding:16px;font-family:Arial, Helvetica, sans-serif;border:2px solid #c9a24d;border-radius:8px;background:#fffdf7;color:#333;box-sizing:border-box;display:flex;flex-direction:column;page-break-after:always;overflow:hidden;">
            <div style="text-align:center;border-bottom:2px solid #c9a24d;padding-bottom:8px;flex-shrink:0;">
              <h2 style="margin:0;color:#7a4b00;font-size:16px;">ISKCON Cultural Centre</h2>
              <p style="margin:2px 0;font-size:11px;">International Society for Krishna Consciousness<br>Registered Trust | 80G &amp; 12A Approved</p>
            </div>
            <h3 style="text-align:center;margin:12px 0 8px 0;color:#5a3600;font-size:14px;flex-shrink:0;">Donation Receipt</h3>
            <table style="width:100%;font-size:11px;border-collapse:collapse;flex-shrink:0;margin-bottom:8px;">
              <tr><td><strong>Receipt No:</strong></td><td>${receiptNumber}</td><td><strong>Date:</strong></td><td>${transactionDate}</td></tr>
              <tr><td><strong>Seva:</strong></td><td colspan="3">${item.name}</td></tr>
              <tr><td><strong>Donor:</strong></td><td colspan="3">${donor.name}</td></tr>
            </table>
            ${qrSectionHTML}
            <div style="margin-top:auto;text-align:center;font-size:9px;">
              <p style="margin:3px 0;"><strong>Amount: ‚Çπ${totalForSeva.toLocaleString()}</strong></p>
              <p style="margin:3px 0;font-style:italic;"><strong>Thank you for your support</strong></p>
            </div>
          </div>
        `;

        allReceiptsHTML += receiptHTML;
      });

      allReceiptsHTML += '</div>';

      showModal(`
        <div style="max-height:600px;overflow-y:auto;margin:-6px;padding:12px;background:white;">
          <div style="text-align:right;margin-bottom:12px;display:flex;gap:8px;justify-content:flex-end;position:sticky;top:0;background:white;padding-bottom:8px;border-bottom:1px solid #e5e7eb;">
            <button type="button" onclick="hideModal()" style="padding:8px 16px;background:#d97706;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">Close</button>
            <button type="button" onclick="printReceipts()" style="padding:8px 16px;background:#16a34a;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">Print All</button>
          </div>
          <div id="receipts-container" style="display:flex;flex-direction:column;align-items:center;gap:0;">
            ${allReceiptsHTML}
          </div>
        </div>
      `);
    }

    function printReceipts() {
      const container = document.getElementById('receipts-container');
      if (!container) {
        showToast('Receipt not found', 'error');
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Print Receipt</title></head><body>');
      printWindow.document.write(container.innerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }

    // Excel Download Functions
    function downloadReportsExcel() {
      const bookings = getFilteredReportBookings();
      
      if (bookings.length === 0) {
        showToast('No reports to download', 'error');
        return;
      }

      // Prepare data for Excel
      const excelData = bookings.map(b => {
        const donor = allData.find(d => d.__backendId === b.donorId);
        const items = b.items ? JSON.parse(b.items) : [];
        const sevaDetails = items.map(i => `${i.name} (Qty: ${i.quantity})`).join(', ');
        const donorName = donor ? donor.name || 'Unknown' : 'Unknown';
        const donorMobile = donor ? donor.mobile : '-';
        const donorEmail = donor ? (donor.email || '-') : '-';
        const totalAmount = items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
        const collectedByDisplay = getCollectorDisplayName(b.collectedBy || 'Unknown');
        const centerName = getCenterName(b.collectedByCenter || b.centerId);

        return {
          'Date': new Date(b.bookingDate).toLocaleDateString('en-GB'),
          'Donor Name': donorName,
          'Mobile': donorMobile,
          'Email': donorEmail,
          'Sevas': sevaDetails,
          'Amount (‚Çπ)': totalAmount,
          'Collected By': collectedByDisplay,
          'Center': centerName,
          'Status': b.paymentStatus || 'pending',
          'Booking ID': b.__backendId
        };
      });

      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(excelData);

      // Set column widths
      ws['!cols'] = [
        { wch: 12 },  // Date
        { wch: 20 },  // Donor Name
        { wch: 15 },  // Mobile
        { wch: 25 },  // Email
        { wch: 40 },  // Sevas
        { wch: 12 },  // Amount
        { wch: 15 },  // Collected By
        { wch: 15 },  // Center
        { wch: 10 },  // Status
        { wch: 25 }   // Booking ID
      ];

      XLSX.utils.book_append_sheet(wb, ws, 'Donation Reports');

      // Generate filename with date range
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;
      let filename = 'Donation_Reports';
      if (startDate) filename += `_from_${startDate}`;
      if (endDate) filename += `_to_${endDate}`;
      filename += `_${new Date().toISOString().split('T')[0]}.xlsx`;

      // Download
      XLSX.writeFile(wb, filename);
      showToast(`Downloaded ${bookings.length} records`);
    }

    function downloadDonorsExcel() {
      const donors = getDonors();
      
      if (donors.length === 0) {
        showToast('No donors to download', 'error');
        return;
      }

      // Get booking stats for each donor
      const bookings = getBookings();

      // Prepare data for Excel - ALL donor fields
      const excelData = donors.map(d => {
        // Calculate donation stats for this donor
        const donorBookings = bookings.filter(b => b.donorId === d.__backendId);
        const totalDonations = donorBookings.reduce((sum, b) => {
          const items = b.items ? JSON.parse(b.items) : [];
          return sum + items.reduce((s, item) => s + (item.amount * item.quantity), 0);
        }, 0);
        
        // Get last donation date
        const lastDonation = donorBookings.length > 0 
          ? new Date(Math.max(...donorBookings.map(b => new Date(b.bookingDate)))).toLocaleDateString('en-GB')
          : 'No donations';

        // Build full address
        const fullAddress = [
          d.flat, d.road, d.po, d.area, d.pincode, d.district, d.state, d.country
        ].filter(Boolean).join(', ');

        return {
          'S.No': '',  // Will be filled below
          'Donor ID': d.__backendId,
          'Legal Name': d.name || '',
          'Spiritual Name': d.spiritualName || '',
          'Indian Passport': d.indianPassport ? 'Yes' : 'No',
          'PAN Number': d.pan || '',
          'Mobile Number': d.mobile || '',
          'WhatsApp Number': d.whatsapp || '',
          'Email Address': d.email || '',
          'Flat / Door / Building': d.flat || '',
          'Road / Street / Block / Sector': d.road || '',
          'Post Office': d.po || '',
          'Area / Locality': d.area || '',
          'Pincode': d.pincode || '',
          'District': d.district || '',
          'State': d.state || '',
          'Country': d.country || 'India',
          'Full Address': fullAddress,
          'Center': getCenterName(d.centerId),
          'Total Bookings': donorBookings.length,
          'Total Donated (‚Çπ)': totalDonations,
          'Average Donation (‚Çπ)': donorBookings.length > 0 ? Math.round(totalDonations / donorBookings.length) : 0,
          'Last Donation Date': lastDonation,
          'Registered On': d.createdAt ? new Date(d.createdAt).toLocaleDateString('en-GB') : '-',
          'Last Updated': d.updatedAt ? new Date(d.updatedAt).toLocaleDateString('en-GB') : '-'
        };
      });

      // Add serial numbers
      excelData.forEach((row, idx) => {
        row['S.No'] = idx + 1;
      });

      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(excelData);

      // Set column widths
      ws['!cols'] = [
        { wch: 5 },   // S.No
        { wch: 28 },  // Donor ID
        { wch: 20 },  // Legal Name
        { wch: 25 },  // Initiated Name
        { wch: 15 },  // Mobile
        { wch: 15 },  // WhatsApp
        { wch: 28 },  // Email
        { wch: 20 },  // Flat
        { wch: 25 },  // Road
        { wch: 15 },  // PO
        { wch: 18 },  // Area
        { wch: 10 },  // Pincode
        { wch: 15 },  // District
        { wch: 15 },  // State
        { wch: 12 },  // Country
        { wch: 50 },  // Full Address
        { wch: 15 },  // Center
        { wch: 12 },  // Total Bookings
        { wch: 15 },  // Total Donated
        { wch: 18 },  // Average Donation
        { wch: 18 },  // Last Donation Date
        { wch: 15 },  // Registered On
        { wch: 15 }   // Last Updated
      ];

      XLSX.utils.book_append_sheet(wb, ws, 'Donors');

      // Generate filename
      const filename = `Donors_Complete_List_${new Date().toISOString().split('T')[0]}.xlsx`;

      // Download
      XLSX.writeFile(wb, filename);
      showToast(`Downloaded ${donors.length} donor records with all fields`);
    }

    // CSV Download Functions
    function downloadAsCSV(data, filename) {
      if (data.length === 0) {
        showToast('No data to download', 'error');
        return;
      }
      
      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => 
          headers.map(header => {
            let cell = row[header] || '';
            // Escape quotes and wrap in quotes if contains comma or quote
            cell = String(cell).replace(/"/g, '""');
            if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
              cell = `"${cell}"`;
            }
            return cell;
          }).join(',')
        )
      ].join('\n');
      
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function downloadAsXML(data, rootName, itemName, filename) {
      if (data.length === 0) {
        showToast('No data to download', 'error');
        return;
      }
      
      let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
      xml += `<${rootName}>\n`;
      
      data.forEach(row => {
        xml += `  <${itemName}>\n`;
        Object.keys(row).forEach(key => {
          const safeKey = key.replace(/[^a-zA-Z0-9]/g, '_');
          const value = String(row[key] || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          xml += `    <${safeKey}>${value}</${safeKey}>\n`;
        });
        xml += `  </${itemName}>\n`;
      });
      
      xml += `</${rootName}>`;
      
      const blob = new Blob([xml], { type: 'application/xml;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    // Get Reports Data for export
    function getReportsExportData() {
      const bookings = getFilteredReportBookings();
      
      return bookings.map(b => {
        const donor = allData.find(d => d.__backendId === b.donorId);
        const items = b.items ? JSON.parse(b.items) : [];
        const sevaDetails = items.map(i => `${i.name} (Qty: ${i.quantity})`).join('; ');
        const donorName = donor ? donor.name || 'Unknown' : 'Unknown';
        const donorMobile = donor ? donor.mobile : '-';
        const donorEmail = donor ? (donor.email || '-') : '-';
        const totalAmount = items.reduce((sum, item) => sum + (item.amount * item.quantity), 0);
        const collectedByDisplay = getCollectorDisplayName(b.collectedBy || 'Unknown');
        const centerName = getCenterName(b.collectedByCenter || b.centerId);

        return {
          'Date': new Date(b.bookingDate).toLocaleDateString('en-GB'),
          'Donor Name': donorName,
          'Mobile': donorMobile,
          'Email': donorEmail,
          'Sevas': sevaDetails,
          'Amount': totalAmount,
          'Collected By': collectedByDisplay,
          'Center': centerName,
          'Status': b.paymentStatus || 'pending',
          'Booking ID': b.__backendId
        };
      });
    }

    // Get Donors Data for export
    function getDonorsExportData() {
      const donors = getDonors();
      const bookings = getBookings();

      return donors.map((d, index) => {
        const donorBookings = bookings.filter(b => b.donorId === d.__backendId);
        const totalDonations = donorBookings.reduce((sum, b) => {
          const items = b.items ? JSON.parse(b.items) : [];
          return sum + items.reduce((s, item) => s + (item.amount * item.quantity), 0);
        }, 0);
        
        const lastDonation = donorBookings.length > 0 
          ? new Date(Math.max(...donorBookings.map(b => new Date(b.bookingDate)))).toLocaleDateString('en-GB')
          : 'No donations';

        const fullAddress = [d.flat, d.road, d.po, d.area, d.pincode, d.district, d.state, d.country].filter(Boolean).join(', ');

        return {
          'S.No': index + 1,
          'Donor ID': d.__backendId,
          'Legal Name': d.name || '',
          'Spiritual Name': d.spiritualName || '',
          'Indian Passport': d.indianPassport ? 'Yes' : 'No',
          'PAN Number': d.pan || '',
          'Mobile': d.mobile || '',
          'WhatsApp': d.whatsapp || '',
          'Email': d.email || '',
          'Flat': d.flat || '',
          'Road': d.road || '',
          'Post Office': d.po || '',
          'Area': d.area || '',
          'Pincode': d.pincode || '',
          'District': d.district || '',
          'State': d.state || '',
          'Country': d.country || 'India',
          'Full Address': fullAddress,
          'Center': getCenterName(d.centerId),
          'Total Bookings': donorBookings.length,
          'Total Donated': totalDonations,
          'Average Donation': donorBookings.length > 0 ? Math.round(totalDonations / donorBookings.length) : 0,
          'Last Donation Date': lastDonation,
          'Registered On': d.createdAt ? new Date(d.createdAt).toLocaleDateString('en-GB') : '-'
        };
      });
    }

    function downloadReportsCSV() {
      const data = getReportsExportData();
      if (data.length === 0) {
        showToast('No reports to download', 'error');
        return;
      }
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;
      let filename = 'Donation_Reports';
      if (startDate) filename += `_from_${startDate}`;
      if (endDate) filename += `_to_${endDate}`;
      filename += `_${new Date().toISOString().split('T')[0]}.csv`;
      downloadAsCSV(data, filename);
      showToast(`Downloaded ${data.length} records as CSV`);
    }

    function downloadReportsXML() {
      const data = getReportsExportData();
      if (data.length === 0) {
        showToast('No reports to download', 'error');
        return;
      }
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;
      let filename = 'Donation_Reports';
      if (startDate) filename += `_from_${startDate}`;
      if (endDate) filename += `_to_${endDate}`;
      filename += `_${new Date().toISOString().split('T')[0]}.xml`;
      downloadAsXML(data, 'DonationReports', 'Booking', filename);
      showToast(`Downloaded ${data.length} records as XML`);
    }

    function downloadDonorsCSV() {
      const data = getDonorsExportData();
      if (data.length === 0) {
        showToast('No donors to download', 'error');
        return;
      }
      const filename = `Donors_List_${new Date().toISOString().split('T')[0]}.csv`;
      downloadAsCSV(data, filename);
      showToast(`Downloaded ${data.length} donor records as CSV`);
    }

    function downloadDonorsXML() {
      const data = getDonorsExportData();
      if (data.length === 0) {
        showToast('No donors to download', 'error');
        return;
      }
      const filename = `Donors_List_${new Date().toISOString().split('T')[0]}.xml`;
      downloadAsXML(data, 'Donors', 'Donor', filename);
      showToast(`Downloaded ${data.length} donor records as XML`);
    }

    // JSON Download Functions
    function downloadAsJSON(data, filename) {
      if (data.length === 0) {
        showToast('No data to download', 'error');
        return;
      }
      
      const jsonContent = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function downloadReportsJSON() {
      const data = getReportsExportData();
      if (data.length === 0) {
        showToast('No reports to download', 'error');
        return;
      }
      const startDate = document.getElementById('report-start-date').value;
      const endDate = document.getElementById('report-end-date').value;
      let filename = 'Donation_Reports';
      if (startDate) filename += `_from_${startDate}`;
      if (endDate) filename += `_to_${endDate}`;
      filename += `_${new Date().toISOString().split('T')[0]}.json`;
      downloadAsJSON(data, filename);
      showToast(`Downloaded ${data.length} records as JSON`);
    }

    function downloadReportsPDF() {
      const bookings = getFilteredReportBookings();
      if (bookings.length === 0) {
        showToast('No reports to download', 'error');
        return;
      }

      // Get donor info for donor accounts
      let donorInfo = null;
      if (currentUser && currentUser.role === 'donor' && currentUser.donorData) {
        donorInfo = currentUser.donorData;
      }

      const totalAmount = bookings.reduce((sum, b) => {
        const items = b.items ? JSON.parse(b.items) : [];
        return sum + items.reduce((s, item) => s + (item.amount * item.quantity), 0);
      }, 0);

      // Build PDF content
      const pdfContent = document.createElement('div');
      pdfContent.style.padding = '20px';
      pdfContent.style.fontFamily = 'Arial, sans-serif';
      pdfContent.style.maxWidth = '800px';
      pdfContent.style.margin = '0 auto';

      pdfContent.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #d97706; padding-bottom: 15px;">
          <h1 style="color: #92400e; margin: 0; font-size: 24px;">üôè My ISKCON Accounts</h1>
          <p style="color: #78350f; margin: 5px 0; font-size: 14px;">Donation Report</p>
          <p style="color: #666; font-size: 12px;">Generated on: ${new Date().toLocaleDateString('en-GB')} at ${new Date().toLocaleTimeString()}</p>
        </div>
        
        ${donorInfo ? `
        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="margin: 0 0 10px 0; color: #92400e;">Donor Information</h3>
          <table style="width: 100%; font-size: 13px;">
            <tr><td style="padding: 3px 0;"><strong>Name:</strong></td><td>${donorInfo.name}</td></tr>
            ${donorInfo.spiritualName ? `<tr><td style="padding: 3px 0;"><strong>Spiritual Name:</strong></td><td>${donorInfo.spiritualName}</td></tr>` : ''}
            <tr><td style="padding: 3px 0;"><strong>Mobile:</strong></td><td>${donorInfo.mobile || '-'}</td></tr>
            <tr><td style="padding: 3px 0;"><strong>Email:</strong></td><td>${donorInfo.email || '-'}</td></tr>
            ${donorInfo.pan ? `<tr><td style="padding: 3px 0;"><strong>PAN:</strong></td><td>${donorInfo.pan}</td></tr>` : ''}
          </table>
        </div>
        ` : ''}
        
        <div style="background: #ecfdf5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h3 style="margin: 0 0 10px 0; color: #065f46;">Summary</h3>
          <table style="width: 100%; font-size: 14px;">
            <tr><td><strong>Total Donations:</strong></td><td style="text-align: right;">${bookings.length}</td></tr>
            <tr><td><strong>Total Amount:</strong></td><td style="text-align: right; font-size: 18px; color: #065f46;"><strong>‚Çπ${totalAmount.toLocaleString()}</strong></td></tr>
          </table>
        </div>
        
        <h3 style="color: #92400e; border-bottom: 1px solid #fcd34d; padding-bottom: 5px;">Donation Details</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px;">
          <thead>
            <tr style="background: #fef3c7;">
              <th style="border: 1px solid #fcd34d; padding: 8px; text-align: left;">Date</th>
              <th style="border: 1px solid #fcd34d; padding: 8px; text-align: left;">Seva</th>
              <th style="border: 1px solid #fcd34d; padding: 8px; text-align: right;">Amount</th>
              <th style="border: 1px solid #fcd34d; padding: 8px; text-align: center;">Status</th>
            </tr>
          </thead>
          <tbody>
            ${bookings.map(b => {
              const items = b.items ? JSON.parse(b.items) : [];
              const sevas = items.map(i => `${i.name} (x${i.quantity})`).join(', ');
              const amount = items.reduce((s, item) => s + (item.amount * item.quantity), 0);
              return `
                <tr>
                  <td style="border: 1px solid #fcd34d; padding: 8px;">${new Date(b.bookingDate).toLocaleDateString('en-GB')}</td>
                  <td style="border: 1px solid #fcd34d; padding: 8px;">${sevas}</td>
                  <td style="border: 1px solid #fcd34d; padding: 8px; text-align: right;">‚Çπ${amount.toLocaleString()}</td>
                  <td style="border: 1px solid #fcd34d; padding: 8px; text-align: center;">
                    <span style="background: ${b.paymentStatus === 'paid' ? '#dcfce7' : '#fef9c3'}; color: ${b.paymentStatus === 'paid' ? '#166534' : '#854d0e'}; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${b.paymentStatus || 'pending'}</span>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        
        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 11px; border-top: 1px solid #e5e7eb; padding-top: 15px;">
          <p>Thank you for your generous donations. Hare Krishna! üôè</p>
          <p>This is a computer-generated report.</p>
        </div>
      `;

      // Use html2pdf to generate PDF
      const opt = {
        margin: 10,
        filename: `Donation_Report_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(pdfContent).save();
      showToast(`Downloaded PDF report with ${bookings.length} records`);
    }

    function downloadDonorsJSON() {
      const data = getDonorsExportData();
      if (data.length === 0) {
        showToast('No donors to download', 'error');
        return;
      }
      const filename = `Donors_List_${new Date().toISOString().split('T')[0]}.json`;
      downloadAsJSON(data, filename);
      showToast(`Downloaded ${data.length} donor records as JSON`);
    }

    // Dashboard Analytics Functions
    function getFilteredBookings() {
      const bookings = getBookings();
      const sevaFilter = document.getElementById('filter-seva').value;
      const dateFilter = document.getElementById('filter-date').value;
      const startDate = document.getElementById('filter-start-date').value;
      const endDate = document.getElementById('filter-end-date').value;

      return bookings.filter(b => {
        if (sevaFilter) {
          const items = b.items ? JSON.parse(b.items) : [];
          const hasSevaId = items.some(item => item.id === sevaFilter);
          if (!hasSevaId) return false;
        }

        const bookingDate = new Date(b.bookingDate);
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay());
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const startOfYear = new Date(today.getFullYear(), 0, 1);

        if (dateFilter === 'today') {
          if (bookingDate.toDateString() !== today.toDateString()) return false;
        } else if (dateFilter === 'week') {
          if (bookingDate < startOfWeek) return false;
        } else if (dateFilter === 'month') {
          if (bookingDate < startOfMonth) return false;
        } else if (dateFilter === 'year') {
          if (bookingDate < startOfYear) return false;
        }

        if (startDate && bookingDate < new Date(startDate)) return false;
        if (endDate && bookingDate > new Date(endDate + 'T23:59:59')) return false;

        return true;
      });
    }

    function updateDashboard() {
      const filteredBookings = getFilteredBookings();
      const uniqueDonors = new Set(filteredBookings.map(b => b.donorId)).size;
      
      let totalRevenue = 0;
      filteredBookings.forEach(b => {
        const items = b.items ? JSON.parse(b.items) : [];
        items.forEach(item => {
          totalRevenue += (item.amount * (item.quantity || 1));
        });
      });
      
      const avgTransaction = filteredBookings.length > 0 ? Math.round(totalRevenue / filteredBookings.length) : 0;

      document.getElementById('stat-bookings').textContent = filteredBookings.length;
      document.getElementById('stat-revenue').textContent = `‚Çπ${totalRevenue.toLocaleString()}`;
      document.getElementById('stat-donors').textContent = uniqueDonors;
      document.getElementById('stat-average').textContent = `‚Çπ${avgTransaction.toLocaleString()}`;

      updateCharts(filteredBookings);
      updateTopSevasTable(filteredBookings);
      updateTransactionsTable(filteredBookings);
    }

    function updateCharts(filteredBookings) {
      const sevaData = {};
      const sevaFilter = document.getElementById('filter-seva').value;
      
      filteredBookings.forEach(b => {
        const items = b.items ? JSON.parse(b.items) : [];
        items.forEach(item => {
          if (!sevaFilter || item.id === sevaFilter) {
            sevaData[item.id] = (sevaData[item.id] || 0) + (item.amount * (item.quantity || 1));
          }
        });
      });

      const sevaLabels = Object.keys(sevaData).map(id => {
        const seva = sevasList.find(s => s.id === id);
        return seva ? seva.name : 'Unknown';
      });
      const sevaValues = Object.values(sevaData);

      if (chartSevaInstance) chartSevaInstance.destroy();
      const ctxSeva = document.getElementById('chart-seva').getContext('2d');
      chartSevaInstance = new Chart(ctxSeva, {
        type: 'bar',
        data: {
          labels: sevaLabels.length > 0 ? sevaLabels : ['No data'],
          datasets: [{
            label: 'Revenue (Rs.)',
            data: sevaValues.length > 0 ? sevaValues : [0],
            backgroundColor: '#d97706',
            borderColor: '#b45309',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });

      const dateData = {};
      filteredBookings.forEach(b => {
        const date = new Date(b.bookingDate).toLocaleDateString('en-GB');
        const items = b.items ? JSON.parse(b.items) : [];
        const bookingTotal = items.reduce((sum, item) => sum + (item.amount * (item.quantity || 1)), 0);
        dateData[date] = (dateData[date] || 0) + bookingTotal;
      });

      const sortedDates = Object.keys(dateData).sort((a, b) => new Date(a) - new Date(b));
      const trendValues = sortedDates.map(date => dateData[date]);

      if (chartTrendInstance) chartTrendInstance.destroy();
      const ctxTrend = document.getElementById('chart-trend').getContext('2d');
      chartTrendInstance = new Chart(ctxTrend, {
        type: 'line',
        data: {
          labels: sortedDates.length > 0 ? sortedDates : ['No data'],
          datasets: [{
            label: 'Daily Revenue (Rs.)',
            data: trendValues.length > 0 ? trendValues : [0],
            borderColor: '#d97706',
            backgroundColor: 'rgba(217, 119, 6, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function updateTopSevasTable(filteredBookings) {
      const sevaStats = {};
      filteredBookings.forEach(b => {
        const items = b.items ? JSON.parse(b.items) : [];
        items.forEach(item => {
          if (!sevaStats[item.id]) {
            sevaStats[item.id] = { name: item.name, bookings: 0, revenue: 0, totalQty: 0 };
          }
          sevaStats[item.id].bookings++;
          sevaStats[item.id].totalQty += (item.quantity || 1);
          sevaStats[item.id].revenue += (item.amount * (item.quantity || 1));
        });
      });

      const topSevas = Object.values(sevaStats)
        .sort((a, b) => b.revenue - a.revenue)
        .slice(0, 10);

      const tbody = document.getElementById('top-sevas-body');
      if (topSevas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-amber-600">No data available</td></tr>';
        return;
      }

      tbody.innerHTML = topSevas.map(seva => {
        const avgPerBooking = Math.round(seva.revenue / seva.bookings);
        return `
          <tr class="border-b border-amber-100 hover:bg-amber-50">
            <td class="py-3 px-4 text-amber-900 font-medium">${seva.name}</td>
            <td class="py-3 px-4 text-amber-700">${seva.bookings}</td>
            <td class="py-3 px-4 text-amber-900 font-semibold">‚Çπ${seva.revenue.toLocaleString()}</td>
            <td class="py-3 px-4 text-amber-700">‚Çπ${avgPerBooking.toLocaleString()}</td>
          </tr>
        `;
      }).join('');
    }

    function updateTransactionsTable(filteredBookings) {
      const tbody = document.getElementById('filtered-transactions-body');

      if (filteredBookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-amber-600">No transactions available</td></tr>';
        return;
      }

      tbody.innerHTML = filteredBookings.map(b => {
        const donor = allData.find(d => d.__backendId === b.donorId);
        const items = b.items ? JSON.parse(b.items) : [];
        const sevaNames = items.map(i => `${i.name} (Qty: ${i.quantity || 1})`).join(', ');
        const donorName = donor ? donor.name || 'Unknown' : 'Unknown';
        
        const correctTotal = items.reduce((sum, item) => sum + (item.amount * (item.quantity || 1)), 0);

        return `
          <tr class="border-b border-amber-100 hover:bg-amber-50">
            <td class="py-3 px-4 text-amber-700 text-sm">${new Date(b.bookingDate).toLocaleDateString('en-GB')}</td>
            <td class="py-3 px-4 text-amber-900 font-medium">${donorName}</td>
            <td class="py-3 px-4 text-amber-700 text-sm">${sevaNames || '-'}</td>
            <td class="py-3 px-4 text-amber-900 font-semibold">‚Çπ${correctTotal.toLocaleString()}</td>
            <td class="py-3 px-4">
              <span class="px-2 py-1 text-xs rounded-full font-medium ${b.paymentStatus === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${b.paymentStatus || 'pending'}</span>
            </td>
          </tr>
        `;
      }).join('');
    }

    function populateSevaFilter() {
      const select = document.getElementById('filter-seva');
      const currentValue = select.value;
      const options = sevasList.map(seva => `
        <option value="${seva.id}">${seva.name}</option>
      `).join('');
      select.innerHTML = '<option value="">All Sevas</option>' + options;
      select.value = currentValue;
    }

    // Donor Functions
    // Comprehensive Indian Pincode Database with ALL Major Indian Pincodes
    const pincodeDatabase = {
      // BENGALURU, KARNATAKA (560001-560110)
      '560001': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Residency Road', country: 'India' },
      '560002': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Shoolay Circle', country: 'India' },
      '560003': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Lalbagh', country: 'India' },
      '560004': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Cantonment', country: 'India' },
      '560005': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Halasuru', country: 'India' },
      '560006': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Infantry Road', country: 'India' },
      '560007': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Langford Town', country: 'India' },
      '560008': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Ulsoor', country: 'India' },
      '560009': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Indira Nagar', country: 'India' },
      '560010': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Nandini Layout', country: 'India' },
      '560011': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Jayanagar', country: 'India' },
      '560012': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Basavanagudi', country: 'India' },
      '560013': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Vasanth Nagar', country: 'India' },
      '560014': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Seshadripuram', country: 'India' },
      '560015': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Sadashiv Nagar', country: 'India' },
      '560016': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Rajajinagar', country: 'India' },
      '560017': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Malleswaram', country: 'India' },
      '560018': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Sankey Road', country: 'India' },
      '560019': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Sadashiv Nagar', country: 'India' },
      '560020': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Mathikere', country: 'India' },
      '560021': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Benson Town', country: 'India' },
      '560022': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Frazer Town', country: 'India' },
      '560023': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Ramamurthy Nagar', country: 'India' },
      '560024': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Hampinagar', country: 'India' },
      '560025': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Whitefield', country: 'India' },
      '560026': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Indiranagar', country: 'India' },
      '560027': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Domlur', country: 'India' },
      '560029': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Kammanahalli', country: 'India' },
      '560030': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Yeshwantpur', country: 'India' },
      '560032': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Shantinagar', country: 'India' },
      '560033': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'CV Raman Nagar', country: 'India' },
      '560034': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Kalyannagar', country: 'India' },
      '560035': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Kamaraj Nagar', country: 'India' },
      '560036': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Nagavara', country: 'India' },
      '560037': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Hennur', country: 'India' },
      '560038': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Akkoddi', country: 'India' },
      '560040': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Rampalli', country: 'India' },
      '560041': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Rajeshwari Nagar', country: 'India' },
      '560042': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Thookhur Nagar', country: 'India' },
      '560043': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Doddagunte Palya', country: 'India' },
      '560045': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Koramangala', country: 'India' },
      '560046': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Indiranagar', country: 'India' },
      '560047': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Badra', country: 'India' },
      '560048': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Banashankari', country: 'India' },
      '560049': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Subramanyapuram', country: 'India' },
      '560050': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Kharatu', country: 'India' },
      '560051': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Kengeri', country: 'India' },
      '560053': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Vijayanagar', country: 'India' },
      '560054': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Hanumanthnagar', country: 'India' },
      '560055': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Hampankatta', country: 'India' },
      '560056': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Gajapati Nagar', country: 'India' },
      '560057': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Sulikunte', country: 'India' },
      '560058': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Arekere', country: 'India' },
      '560059': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Begur', country: 'India' },
      '560060': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Attiguppe', country: 'India' },
      '560061': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'BTM Layout', country: 'India' },
      '560062': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'HSR Layout', country: 'India' },
      '560064': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Ejipura', country: 'India' },
      '560065': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Madiwala', country: 'India' },
      '560066': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Bannerghatta', country: 'India' },
      '560067': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Hongasandra', country: 'India' },
      '560068': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Singasandra', country: 'India' },
      '560069': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Bannerghatta Road', country: 'India' },
      '560070': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Doddakannelli', country: 'India' },
      '560071': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'JP Nagar', country: 'India' },
      '560072': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Jayamahal', country: 'India' },
      '560073': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Yelahanka', country: 'India' },
      '560074': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Arkavathi Layout', country: 'India' },
      '560075': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Gottigere', country: 'India' },
      '560076': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Sanjay Nagar', country: 'India' },
      '560077': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Bhavani Nagar', country: 'India' },
      '560078': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Varthur', country: 'India' },
      '560079': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Sarjapur', country: 'India' },
      '560080': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Marathahalli', country: 'India' },
      '560081': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Sampigehalli', country: 'India' },
      '560082': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Jakkasandra', country: 'India' },
      '560083': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Rampura', country: 'India' },
      '560084': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Soukya Road', country: 'India' },
      '560085': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Aksharanagar', country: 'India' },
      '560086': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Kasavanahalli', country: 'India' },
      '560087': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Gottigere', country: 'India' },
      '560088': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Devarachikere', country: 'India' },
      '560089': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Chikkalasandra', country: 'India' },
      '560090': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Basaveshwaranagar', country: 'India' },
      '560091': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Kalasipalya', country: 'India' },
      '560092': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Yeshwanthpur', country: 'India' },
      '560093': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Bhadrappa Layout', country: 'India' },
      '560094': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Rajajinagar', country: 'India' },
      '560095': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Vyalikaval', country: 'India' },
      '560096': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Peenya', country: 'India' },
      '560097': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Binnamangala', country: 'India' },
      '560098': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Sanjaynagar', country: 'India' },
      '560099': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Lalbagh', country: 'India' },
      '560100': { district: 'Bengaluru', state: 'Karnataka', city: 'Bengaluru', area: 'Tannery Road', country: 'India' },

      // MYSURU, KARNATAKA
      '570001': { district: 'Mysuru', state: 'Karnataka', city: 'Mysuru', area: 'Mysuru City', country: 'India' },
      '570002': { district: 'Mysuru', state: 'Karnataka', city: 'Mysuru', area: 'Krishnaraja Pet', country: 'India' },
      '570003': { district: 'Mysuru', state: 'Karnataka', city: 'Mysuru', area: 'Dakshinkanthi', country: 'India' },
      '570004': { district: 'Mysuru', state: 'Karnataka', city: 'Mysuru', area: 'Srirangapatna', country: 'India' },
      '570005': { district: 'Mysuru', state: 'Karnataka', city: 'Mysuru', area: 'Pandavapura', country: 'India' },
      '570006': { district: 'Mysuru', state: 'Karnataka', city: 'Mysuru', area: 'Mandya', country: 'India' },
      '570007': { district: 'Mysuru', state: 'Karnataka', city: 'Mysuru', area: 'Krishnaraganagudi', country: 'India' },
      '570008': { district: 'Mysuru', state: 'Karnataka', city: 'Mysuru', area: 'Bandipur', country: 'India' },

      // COIMBATORE, TAMIL NADU
      '641001': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Coimbatore City', country: 'India' },
      '641002': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Ramnagar', country: 'India' },
      '641003': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Town Hall', country: 'India' },
      '641004': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Gandhipuram', country: 'India' },
      '641005': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Brookefields', country: 'India' },
      '641006': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Saibaba Colony', country: 'India' },
      '641009': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Koundampalayam', country: 'India' },
      '641010': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Pappanaickenpalayam', country: 'India' },
      '641011': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Peelamedu', country: 'India' },
      '641012': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Kithoor', country: 'India' },
      '641013': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Saravanampatty', country: 'India' },
      '641014': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Avinashi Road', country: 'India' },
      '641015': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Sundarapuram', country: 'India' },
      '641016': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Marudamalai', country: 'India' },
      '641017': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Mettupalayam', country: 'India' },
      '641018': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Uthukuli', country: 'India' },
      '641019': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Pollachi', country: 'India' },
      '641020': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Tiruppur', country: 'India' },
      '641021': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Sulur', country: 'India' },
      '641022': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Varadharajapuram', country: 'India' },
      '641023': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Elayampalayam', country: 'India' },
      '641024': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Kanuvai', country: 'India' },
      '641025': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Chinnathadagam', country: 'India' },
      '641026': { district: 'Coimbatore', state: 'Tamil Nadu', city: 'Coimbatore', area: 'Malumichampatti', country: 'India' },

      // DELHI
      '110001': { district: 'New Delhi', state: 'Delhi', city: 'Delhi', area: 'Connaught Place', country: 'India' },
      '110002': { district: 'Central Delhi', state: 'Delhi', city: 'Delhi', area: 'Kasturba Nagar', country: 'India' },
      '110003': { district: 'Central Delhi', state: 'Delhi', city: 'Delhi', area: 'Chandni Chowk', country: 'India' },
      '110004': { district: 'New Delhi', state: 'Delhi', city: 'Delhi', area: 'Raj Path', country: 'India' },
      '110005': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Safdarjang', country: 'India' },
      '110006': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Defence Colony', country: 'India' },
      '110007': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Karol Bagh', country: 'India' },
      '110008': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Greater Kailash', country: 'India' },
      '110009': { district: 'Central Delhi', state: 'Delhi', city: 'Delhi', area: 'Old Delhi', country: 'India' },
      '110010': { district: 'Central Delhi', state: 'Delhi', city: 'Delhi', area: 'Daryaganj', country: 'India' },
      '110011': { district: 'North Delhi', state: 'Delhi', city: 'Delhi', area: 'Azadpur', country: 'India' },
      '110012': { district: 'North Delhi', state: 'Delhi', city: 'Delhi', area: 'Chandni Chowk', country: 'India' },
      '110013': { district: 'North Delhi', state: 'Delhi', city: 'Delhi', area: 'Civil Lines', country: 'India' },
      '110014': { district: 'North Delhi', state: 'Delhi', city: 'Delhi', area: 'Kasturba Nagar', country: 'India' },
      '110015': { district: 'West Delhi', state: 'Delhi', city: 'Delhi', area: 'Patel Nagar', country: 'India' },
      '110016': { district: 'West Delhi', state: 'Delhi', city: 'Delhi', area: 'Rajpur Road', country: 'India' },
      '110017': { district: 'North West Delhi', state: 'Delhi', city: 'Delhi', area: 'Rohini', country: 'India' },
      '110018': { district: 'North East Delhi', state: 'Delhi', city: 'Delhi', area: 'Shahdara', country: 'India' },
      '110019': { district: 'East Delhi', state: 'Delhi', city: 'Delhi', area: 'Laxmi Nagar', country: 'India' },
      '110020': { district: 'East Delhi', state: 'Delhi', city: 'Delhi', area: 'IP Extension', country: 'India' },
      '110021': { district: 'South West Delhi', state: 'Delhi', city: 'Delhi', area: 'Dwarka', country: 'India' },
      '110022': { district: 'South East Delhi', state: 'Delhi', city: 'Delhi', area: 'Kalkaji', country: 'India' },
      '110023': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Chhatarpur', country: 'India' },
      '110024': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Mehrauli', country: 'India' },
      '110025': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Malviya Nagar', country: 'India' },
      '110026': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'South Extension', country: 'India' },
      '110027': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Hauz Khas', country: 'India' },
      '110028': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Block 23 Rani Garden', country: 'India' },
      '110029': { district: 'South Delhi', state: 'Delhi', city: 'Delhi', area: 'Pushp Vihar', country: 'India' },
      '110030': { district: 'South East Delhi', state: 'Delhi', city: 'Delhi', area: 'Kalkaji Extn', country: 'India' },

      // MUMBAI, MAHARASHTRA
      '400001': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Fort', country: 'India' },
      '400002': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Colaba', country: 'India' },
      '400003': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Cuffe Parade', country: 'India' },
      '400004': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Kala Ghoda', country: 'India' },
      '400005': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Kalachowkie', country: 'India' },
      '400006': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Fort Area', country: 'India' },
      '400007': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Fountain', country: 'India' },
      '400008': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Dhobi Talao', country: 'India' },
      '400009': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Grant Road', country: 'India' },
      '400010': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Chira Bazar', country: 'India' },
      '400011': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Kalbadevi', country: 'India' },
      '400012': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Girgaum', country: 'India' },
      '400013': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Gowalia Tank', country: 'India' },
      '400014': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Malabar Hill', country: 'India' },
      '400015': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Byculla', country: 'India' },
      '400016': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Parel', country: 'India' },
      '400017': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Dockyard Road', country: 'India' },
      '400018': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Mazagaon', country: 'India' },
      '400019': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Navy Nagar', country: 'India' },
      '400020': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Virar West', country: 'India' },
      '400021': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Virar East', country: 'India' },
      '400022': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Borivali West', country: 'India' },
      '400023': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Borivali East', country: 'India' },
      '400024': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Malad West', country: 'India' },
      '400025': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Malad East', country: 'India' },
      '400026': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Jogeshwari West', country: 'India' },
      '400027': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Jogeshwari East', country: 'India' },
      '400028': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Goregaon West', country: 'India' },
      '400029': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Goregaon East', country: 'India' },
      '400030': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Kandivali West', country: 'India' },
      '400031': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Kandivali East', country: 'India' },
      '400032': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Powai', country: 'India' },
      '400033': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Thane West', country: 'India' },
      '400034': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Chembur', country: 'India' },
      '400035': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Trombay', country: 'India' },
      '400036': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Mulund West', country: 'India' },
      '400037': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Mulund East', country: 'India' },
      '400038': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Ghatkopar West', country: 'India' },
      '400039': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Ghatkopar East', country: 'India' },
      '400040': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Vikhroli West', country: 'India' },
      '400041': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Vikhroli East', country: 'India' },
      '400042': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Kanjurmarg', country: 'India' },
      '400043': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Andheri West', country: 'India' },
      '400044': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Andheri East', country: 'India' },
      '400045': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Versova', country: 'India' },
      '400046': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Vile Parle West', country: 'India' },
      '400047': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Vile Parle East', country: 'India' },
      '400048': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Santacruz West', country: 'India' },
      '400049': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Santacruz East', country: 'India' },
      '400050': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Bandra West', country: 'India' },
      '400051': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Bandra East', country: 'India' },
      '400052': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Khar', country: 'India' },
      '400053': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Mahim', country: 'India' },
      '400054': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Worli', country: 'India' },
      '400055': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Lower Parel', country: 'India' },
      '400056': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Prabhadevi', country: 'India' },
      '400057': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Dadar East', country: 'India' },
      '400058': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Dadar West', country: 'India' },
      '400059': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Shivaji Park', country: 'India' },
      '400060': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Matunga', country: 'India' },
      '400061': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Wadala', country: 'India' },
      '400062': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Grant Road Gaothan', country: 'India' },
      '400063': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Mankhurd', country: 'India' },
      '400064': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Govandi', country: 'India' },
      '400065': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Mumbra', country: 'India' },
      '400066': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Dombivali East', country: 'India' },
      '400067': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Dombivali West', country: 'India' },
      '400068': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Titwala', country: 'India' },
      '400069': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Kalyan West', country: 'India' },
      '400070': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Kalyan East', country: 'India' },
      '400071': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Ulhasnagar', country: 'India' },
      '400072': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Ambarnath', country: 'India' },
      '400073': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Vasai', country: 'India' },
      '400074': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Vasai East', country: 'India' },
      '400075': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Mira Road', country: 'India' },
      '400076': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Bhayandar West', country: 'India' },
      '400077': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Bhayandar East', country: 'India' },
      '400078': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Nallasopara', country: 'India' },
      '400079': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Vasai West', country: 'India' },
      '400080': { district: 'Mumbai', state: 'Maharashtra', city: 'Mumbai', area: 'Arnala', country: 'India' },

      // PUNE, MAHARASHTRA
      '411001': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Camp', country: 'India' },
      '411002': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Somwar Peth', country: 'India' },
      '411003': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Ravivar Peth', country: 'India' },
      '411004': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Dhobi Talao', country: 'India' },
      '411005': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Gulmarg', country: 'India' },
      '411006': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Shivajinagar', country: 'India' },
      '411007': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Model Colony', country: 'India' },
      '411008': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Erandwane', country: 'India' },
      '411009': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Bibwewadi', country: 'India' },
      '411010': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Donje', country: 'India' },
      '411011': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Hadapsar', country: 'India' },
      '411012': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Baner', country: 'India' },
      '411013': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Pashan', country: 'India' },
      '411014': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Aundh', country: 'India' },
      '411015': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Bavdhan', country: 'India' },
      '411016': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Warje', country: 'India' },
      '411017': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Kothrud', country: 'India' },
      '411018': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Vimantal', country: 'India' },
      '411019': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Kondhwa', country: 'India' },
      '411020': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Manjri', country: 'India' },
      '411021': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Sinhagad Road', country: 'India' },
      '411022': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Wanaowri', country: 'India' },
      '411023': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Pune Sadar', country: 'India' },
      '411024': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Kharadi', country: 'India' },
      '411025': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Balaji Nagar', country: 'India' },
      '411026': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Hinjewadi', country: 'India' },
      '411027': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Pisoli', country: 'India' },
      '411028': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Kalyani Nagar', country: 'India' },
      '411029': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Tathawade', country: 'India' },
      '411030': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Pimpri', country: 'India' },
      '411031': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Nigdi', country: 'India' },
      '411032': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Chakan', country: 'India' },
      '411033': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Wakad', country: 'India' },
      '411034': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Punawale', country: 'India' },
      '411035': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Jejuri', country: 'India' },
      '411036': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Talegaon Dabhade', country: 'India' },
      '411037': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Narayangaon', country: 'India' },
      '411038': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Alandi', country: 'India' },
      '411039': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Ranjangaon', country: 'India' },
      '411040': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Lonavla', country: 'India' },
      '411041': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Khandala', country: 'India' },
      '411042': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Rajgurunagar', country: 'India' },
      '411043': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Belhe', country: 'India' },
      '411044': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Khopoli', country: 'India' },
      '411045': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Purna', country: 'India' },
      '411046': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Ambegaon', country: 'India' },
      '411047': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Shirur', country: 'India' },
      '411048': { district: 'Pune', state: 'Maharashtra', city: 'Pune', area: 'Khed', country: 'India' },

      // HYDERABAD, TELANGANA
      '500001': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Secretariat', country: 'India' },
      '500002': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Hyderabad Fort', country: 'India' },
      '500003': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Charminar', country: 'India' },
      '500004': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Hussain Sagar', country: 'India' },
      '500005': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Banjara Hills', country: 'India' },
      '500006': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Amberpet', country: 'India' },
      '500007': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Kachiguda', country: 'India' },
      '500008': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Secunderabad', country: 'India' },
      '500009': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Somajiguda', country: 'India' },
      '500010': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Nampally', country: 'India' },
      '500011': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Himayatnagar', country: 'India' },
      '500012': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Abids', country: 'India' },
      '500013': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Lakdikapool', country: 'India' },
      '500014': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Khajaguda', country: 'India' },
      '500015': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Madhura Nagar', country: 'India' },
      '500016': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Begumpet', country: 'India' },
      '500017': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Saidabad', country: 'India' },
      '500018': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'L B Nagar', country: 'India' },
      '500019': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Uppal', country: 'India' },
      '500020': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Dilshuknagar', country: 'India' },
      '500021': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Vanasthalipuram', country: 'India' },
      '500022': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Rajendranagar', country: 'India' },
      '500023': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Ibrahimpatnam', country: 'India' },
      '500024': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Hayathnagar', country: 'India' },
      '500025': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Shamshabad', country: 'India' },
      '500026': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Kolhatur', country: 'India' },
      '500027': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Ecil', country: 'India' },
      '500028': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Malkajgiri', country: 'India' },
      '500029': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Salarjung', country: 'India' },
      '500030': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Mehdipatnam', country: 'India' },
      '500031': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Owaisi Mill', country: 'India' },
      '500032': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Mirzaguda', country: 'India' },
      '500033': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Patancheru', country: 'India' },
      '500034': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Sangareddy', country: 'India' },
      '500035': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Medchal', country: 'India' },
      '500036': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Moinabad', country: 'India' },
      '500037': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Tandur', country: 'India' },
      '500038': { district: 'Hyderabad', state: 'Telangana', city: 'Hyderabad', area: 'Tandoor', country: 'India' },

      // KOLKATA, WEST BENGAL
      '700001': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Dakshineswar', country: 'India' },
      '700002': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Belgachia', country: 'India' },
      '700003': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Shyambazar', country: 'India' },
      '700004': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Shyam Bazar', country: 'India' },
      '700005': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Sovabazar', country: 'India' },
      '700006': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Chitpur', country: 'India' },
      '700007': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Kumartuli', country: 'India' },
      '700008': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Shantinagar', country: 'India' },
      '700009': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Jorasanko', country: 'India' },
      '700010': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Baghbazar', country: 'India' },
      '700011': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Georagali', country: 'India' },
      '700012': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Pathuriaghata', country: 'India' },
      '700013': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Bowbazar', country: 'India' },
      '700014': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Entally', country: 'India' },
      '700015': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Chetla', country: 'India' },
      '700016': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'New Market', country: 'India' },
      '700017': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Siddeshwari', country: 'India' },
      '700018': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Shyampukur', country: 'India' },
      '700019': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Chowringhee', country: 'India' },
      '700020': { district: 'Howrah', state: 'West Bengal', city: 'Howrah', area: 'Howrah', country: 'India' },
      '700021': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Rameswar Chatterjee Street', country: 'India' },
      '700022': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Free School Street', country: 'India' },
      '700023': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Ballygunge Circular Road', country: 'India' },
      '700024': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Bhawanipur', country: 'India' },
      '700025': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Alipore', country: 'India' },
      '700026': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Avishek Garh', country: 'India' },
      '700027': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Ballygunge', country: 'India' },
      '700028': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Behala', country: 'India' },
      '700029': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Thakurpukur', country: 'India' },
      '700030': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Jadavpur', country: 'India' },
      '700031': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Narendrapur', country: 'India' },
      '700032': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Cossipore', country: 'India' },
      '700033': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Tangra', country: 'India' },
      '700034': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Ultadanga', country: 'India' },
      '700035': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Dunlop', country: 'India' },
      '700036': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Tehkhand', country: 'India' },
      '700037': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Baranagar', country: 'India' },
      '700038': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Khardah', country: 'India' },
      '700039': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Salt Lake', country: 'India' },
      '700040': { district: 'Kolkata', state: 'West Bengal', city: 'Kolkata', area: 'Sector V', country: 'India' },

      // LUCKNOW, UTTAR PRADESH
      '226001': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Lucknow City', country: 'India' },
      '226002': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Chaarbagh', country: 'India' },
      '226003': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Aminabad', country: 'India' },
      '226004': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Ganj Kayora', country: 'India' },
      '226005': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Baag Lucknow', country: 'India' },
      '226006': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Qaisar Bagh', country: 'India' },
      '226007': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Hazratganj', country: 'India' },
      '226008': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Ameenpur', country: 'India' },
      '226009': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Alambagh', country: 'India' },
      '226010': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Charbagh Naka', country: 'India' },
      '226011': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Lakshmi Nagar', country: 'India' },
      '226012': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Gomti Nagar', country: 'India' },
      '226013': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Indira Nagar', country: 'India' },
      '226014': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Sahara Ganj', country: 'India' },
      '226015': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Vikas Nagar', country: 'India' },
      '226016': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Vrindavan Yojana', country: 'India' },
      '226017': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Aashiana', country: 'India' },
      '226018': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Rajajipuram', country: 'India' },
      '226019': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Chhota Imambara', country: 'India' },
      '226020': { district: 'Lucknow', state: 'Uttar Pradesh', city: 'Lucknow', area: 'Shaheed Path', country: 'India' },

      // JAIPUR, RAJASTHAN
      '302001': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Jaipur City', country: 'India' },
      '302002': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Ramgarh', country: 'India' },
      '302003': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Johari Bazar', country: 'India' },
      '302004': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Bapu Bazar', country: 'India' },
      '302005': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Chaura Rasta', country: 'India' },
      '302006': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Amer Road', country: 'India' },
      '302012': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Malviya Nagar', country: 'India' },
      '302013': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Rajendra Nagar', country: 'India' },
      '302015': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Adarsh Nagar', country: 'India' },
      '302016': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Shyam Nagar', country: 'India' },
      '302017': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Santosh Nagar', country: 'India' },
      '302018': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Vidhyadhar Nagar', country: 'India' },
      '302019': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Solanpur', country: 'India' },
      '302020': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Jawaharlal Nehru Marg', country: 'India' },
      '302021': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Mansarovar', country: 'India' },
      '302022': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Sikar Road', country: 'India' },
      '302023': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Narayana Nagar', country: 'India' },
      '302024': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Sodala', country: 'India' },
      '302025': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Rajpur', country: 'India' },
      '302026': { district: 'Jaipur', state: 'Rajasthan', city: 'Jaipur', area: 'Pooja Nagar', country: 'India' },

      // AHMEDABAD, GUJARAT
      '380001': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Ahmedabad City', country: 'India' },
      '380002': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Kalupur', country: 'India' },
      '380003': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Bhadra', country: 'India' },
      '380004': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Sarangpur', country: 'India' },
      '380005': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Walled City', country: 'India' },
      '380006': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Manek Chowk', country: 'India' },
      '380007': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Jamalpur', country: 'India' },
      '380008': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'New York Tower', country: 'India' },
      '380009': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Navrangpura', country: 'India' },
      '380010': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'University Road', country: 'India' },
      '380013': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Relief Road', country: 'India' },
      '380014': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Saat Rasta', country: 'India' },
      '380015': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Thaltej', country: 'India' },
      '380016': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Bopal', country: 'India' },
      '380017': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Vastrapur', country: 'India' },
      '380018': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Paldi', country: 'India' },
      '380019': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Ramdev Nagar', country: 'India' },
      '380020': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Rajpur', country: 'India' },
      '380021': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Satellite', country: 'India' },
      '380022': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Gurukul Road', country: 'India' },
      '380023': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Iscon', country: 'India' },
      '380024': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Judges Bungalow Road', country: 'India' },
      '380025': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Mithakhali Six Roads', country: 'India' },
      '380026': { district: 'Ahmedabad', state: 'Gujarat', city: 'Ahmedabad', area: 'Girish Cold Storage Road', country: 'India' },

      // SURAT, GUJARATI
      '395001': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Surat City', country: 'India' },
      '395002': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Athwajan', country: 'India' },
      '395003': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Vesu', country: 'India' },
      '395004': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Katargam', country: 'India' },
      '395005': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Mapusa', country: 'India' },
      '395006': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Adajan', country: 'India' },
      '395007': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Pal', country: 'India' },
      '395008': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Dumbhal', country: 'India' },
      '395009': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Rander', country: 'India' },
      '395010': { district: 'Surat', state: 'Gujarat', city: 'Surat', area: 'Kiran Garden', country: 'India' }
    };

    function lookupPincode(pincode, isModalForm = false) {
      const prefix = isModalForm ? 'modal-' : '';
      const statusDiv = document.getElementById(prefix + 'pincode-status');
      const districtField = document.getElementById(prefix + 'donor-district');
      const stateField = document.getElementById(prefix + 'donor-state');
      const countryField = document.getElementById(prefix + 'donor-country');
      
      if (!pincode || pincode.length !== 6) {
        districtField.value = '';
        stateField.value = '';
        countryField.value = 'India';
        districtField.removeAttribute('readonly');
        stateField.removeAttribute('readonly');
        statusDiv.textContent = '';
        return;
      }

      const data = pincodeDatabase[pincode];
      
      if (data) {
        districtField.value = data.district;
        stateField.value = data.state;
        countryField.value = data.country;
        districtField.setAttribute('readonly', true);
        stateField.setAttribute('readonly', true);
        statusDiv.textContent = '‚úì Valid pincode - details auto-filled';
        statusDiv.classList.remove('text-red-600');
        statusDiv.classList.add('text-green-600');
      } else {
        districtField.value = '';
        stateField.value = '';
        countryField.value = 'India';
        districtField.removeAttribute('readonly');
        stateField.removeAttribute('readonly');
        statusDiv.textContent = '‚ö† Pincode not found - please enter details manually below';
        statusDiv.classList.remove('text-green-600');
        statusDiv.classList.add('text-amber-600');
      }
    }

    function selectDonor(donorId) {
      const donor = getDonors().find(d => d.__backendId === donorId);
      if (donor) {
        document.getElementById('donor-id').value = donor.__backendId;
        document.getElementById('donor-name').value = donor.name || '';
        document.getElementById('donor-spiritual-name').value = donor.spiritualName || '';
        document.getElementById('donor-indian-passport').checked = donor.indianPassport || false;
        document.getElementById('donor-pan').value = donor.pan || '';
        document.getElementById('donor-mobile').value = donor.mobile || '';
        document.getElementById('donor-whatsapp').value = donor.whatsapp || '';
        document.getElementById('donor-email').value = donor.email || '';
        document.getElementById('donor-flat').value = donor.flat || '';
        document.getElementById('donor-road').value = donor.road || '';
        document.getElementById('donor-po').value = donor.po || '';
        document.getElementById('donor-area').value = donor.area || '';
        document.getElementById('donor-pincode').value = donor.pincode || '';
        document.getElementById('donor-district').value = donor.district || '';
        document.getElementById('donor-state').value = donor.state || '';
        document.getElementById('donor-country').value = donor.country || 'India';
        document.getElementById('donor-center').value = donor.centerId || currentUser.centerId || 'center_bangalore';
        switchTab('booking');
        showToast('Donor selected');
      }
    }

    function clearDonorForm() {
      document.getElementById('donor-id').value = '';
      document.getElementById('donor-name').value = '';
      document.getElementById('donor-spiritual-name').value = '';
      document.getElementById('donor-indian-passport').checked = false;
      document.getElementById('donor-pan').value = '';
      document.getElementById('donor-mobile').value = '';
      document.getElementById('donor-whatsapp').value = '';
      document.getElementById('donor-email').value = '';
      document.getElementById('donor-flat').value = '';
      document.getElementById('donor-road').value = '';
      document.getElementById('donor-po').value = '';
      document.getElementById('donor-area').value = '';
      document.getElementById('donor-pincode').value = '';
      document.getElementById('donor-district').value = '';
      document.getElementById('donor-state').value = '';
      document.getElementById('donor-country').value = 'India';
      document.getElementById('donor-center').value = currentUser?.centerId || 'center_bangalore';
      document.getElementById('pincode-status').textContent = '';
    }

    async function searchDonor() {
      const mobile = document.getElementById('search-mobile').value.trim();
      const resultDiv = document.getElementById('search-result');

      if (!mobile) {
        resultDiv.innerHTML = '<span class="text-amber-600">Please enter a mobile number</span>';
        return;
      }

      const donor = getDonors().find(d => d.mobile === mobile);
      
      if (donor) {
        resultDiv.innerHTML = `<span class="text-green-600">Found: ${donor.name}</span>`;
        selectDonor(donor.__backendId);
      } else {
        resultDiv.innerHTML = `<span class="text-amber-600">Not found. Fill details below for new donor.</span>`;
        clearDonorForm();
        document.getElementById('donor-mobile').value = mobile;
      }
    }

    function showSearchDropdown() {
      const searchInput = document.getElementById('search-mobile').value.trim();
      const dropdown = document.getElementById('search-dropdown');
      const resultDiv = document.getElementById('search-result');

      if (!searchInput) {
        dropdown.classList.add('hidden');
        resultDiv.innerHTML = '';
        return;
      }

      // Find all donors matching the search input
      const matchingDonors = getDonors().filter(d => 
        d.mobile.includes(searchInput)
      );

      if (matchingDonors.length === 0) {
        dropdown.classList.add('hidden');
        resultDiv.innerHTML = `<span class="text-amber-600">No matching donors found</span>`;
        return;
      }

      // Show dropdown with matching donors
      dropdown.innerHTML = matchingDonors.map(donor => `
        <div class="px-4 py-3 hover:bg-amber-50 cursor-pointer border-b border-amber-100 transition donor-option" data-donor-id="${donor.__backendId}">
          <div class="font-semibold text-amber-900">${donor.name}</div>
          <div class="text-sm text-amber-600">üì± ${donor.mobile}</div>
          ${donor.email ? `<div class="text-sm text-amber-600">‚úâÔ∏è ${donor.email}</div>` : ''}
          ${donor.pincode ? `<div class="text-sm text-amber-600">üìç ${donor.area || ''} - ${donor.pincode}</div>` : ''}
        </div>
      `).join('');

      dropdown.classList.remove('hidden');

      // Add click handlers to dropdown items
      dropdown.querySelectorAll('.donor-option').forEach(option => {
        option.addEventListener('click', () => {
          const donorId = option.dataset.donorId;
          selectDonor(donorId);
          document.getElementById('search-mobile').value = '';
          dropdown.classList.add('hidden');
          resultDiv.innerHTML = '';
        });
      });
    }

    // Modal Forms
    function showAddUserModal() {
      showModal(`
        <h3 class="font-display text-xl font-semibold text-amber-900 mb-4">Add New User</h3>
        <form id="add-user-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Username *</label>
            <input type="text" id="new-username" required class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Password *</label>
            <input type="password" id="new-password" required class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Role *</label>
            <select id="new-role" required class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
              <option value="volunteer">Volunteer</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Center/Location *</label>
            <select id="new-center-id" required class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
              <option value="">Select a center...</option>
              <option value="center_bangalore">Bangalore Center</option>
              <option value="center_delhi">Delhi Center</option>
              <option value="center_mumbai">Mumbai Center</option>
              <option value="center_chennai">Chennai Center</option>
              <option value="center_kolkata">Kolkata Center</option>
            </select>
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
            <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg">Add User</button>
          </div>
        </form>
      `);

      document.getElementById('add-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('new-username').value.trim();
        const password = document.getElementById('new-password').value;
        const role = document.getElementById('new-role').value;
        const centerId = document.getElementById('new-center-id').value;

        if (!centerId) {
          showToast('Please select a center', 'error');
          return;
        }

        // Check if username already exists in this specific center
        const existingUser = allData.find(d => 
          d.type === 'user' && 
          d.username === username && 
          d.centerId === centerId &&
          d.username !== 'admin'
        );

        if (existingUser) {
          showToast('Username already exists in this center', 'error');
          return;
        }

        let defaultPermissions = {};
        allPermissions.forEach(perm => {
          defaultPermissions[perm.id] = perm.default;
        });

        const result = await window.dataSdk.create({
          type: 'user',
          username,
          password,
          role,
          centerId,
          permissions: JSON.stringify(defaultPermissions),
          createdBy: currentUser.username,
          createdAt: new Date().toISOString()
        });

        if (result.isOk) {
          hideModal();
          showToast('User added successfully');
        } else {
          showToast('Failed to add user', 'error');
        }
      });
    }

    function confirmDeleteUser(userId) {
      showModal(`
        <h3 class="font-display text-xl font-semibold text-amber-900 mb-4">Confirm Delete</h3>
        <p class="text-amber-700 mb-6">Are you sure you want to delete this user? This action cannot be undone.</p>
        <div class="flex gap-3">
          <button onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
          <button onclick="deleteUser('${userId}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg">Delete</button>
        </div>
      `);
    }

    async function deleteUser(userId) {
      const user = allData.find(d => d.__backendId === userId);
      if (user) {
        const result = await window.dataSdk.delete(user);
        if (result.isOk) {
          hideModal();
          showToast('User deleted');
        }
      }
    }

    function showAddDonorModal() {
      showModal(`
        <h3 class="font-display text-xl font-semibold text-amber-900 mb-4">Add New Donor</h3>
        <form id="add-donor-form" class="space-y-3 max-h-[80vh] overflow-y-auto pr-2">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Legal Name *</label>
            <input type="text" id="modal-donor-name" required class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Full name (First and Last)">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Spiritual Name (Optional)</label>
            <input type="text" id="modal-donor-spiritual-name" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Initiated name if applicable">
          </div>
          <div class="flex items-center gap-2 py-2">
            <input type="checkbox" id="modal-donor-indian-passport" class="w-4 h-4 text-amber-600 border-amber-300 rounded focus:ring-amber-500">
            <label for="modal-donor-indian-passport" class="text-sm font-medium text-amber-700">Indian Passport Holder</label>
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">PAN Number</label>
            <input type="text" id="modal-donor-pan" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none uppercase" placeholder="ABCDE1234F" maxlength="10">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Mobile *</label>
            <input type="tel" id="modal-donor-mobile" required class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">WhatsApp</label>
            <input type="tel" id="modal-donor-whatsapp" class="w-full px-3 py-2 border border-amber-200 rounded-lg bg-amber-50 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Auto-filled from mobile">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Email</label>
            <input type="email" id="modal-donor-email" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          
          <div class="border-t border-amber-200 pt-3 mt-3">
            <p class="text-xs font-semibold text-amber-800 mb-2">üìç Address Details</p>
            
            <div>
              <label class="block text-xs font-medium text-amber-700 mb-1">Flat / Door / Building</label>
              <input type="text" id="modal-donor-flat" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            
            <div class="mt-2">
              <label class="block text-xs font-medium text-amber-700 mb-1">Road / Street / Block / Sector</label>
              <input type="text" id="modal-donor-road" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            
            <div class="mt-2">
              <label class="block text-xs font-medium text-amber-700 mb-1">Post Office</label>
              <input type="text" id="modal-donor-po" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            
            <div class="mt-2">
              <label class="block text-xs font-medium text-amber-700 mb-1">Area / Locality</label>
              <input type="text" id="modal-donor-area" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            
            <div class="mt-2">
              <label class="block text-xs font-medium text-amber-700 mb-1">Pincode *</label>
              <input type="text" id="modal-donor-pincode" maxlength="6" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Enter 6-digit pincode">
              <div id="modal-pincode-status" class="text-xs mt-1 text-amber-600"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <label class="block text-xs font-medium text-amber-700 mb-1">District</label>
                <input type="text" id="modal-donor-district" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly placeholder="Auto-filled">
              </div>
              <div>
                <label class="block text-xs font-medium text-amber-700 mb-1">State</label>
                <input type="text" id="modal-donor-state" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly placeholder="Auto-filled">
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <label class="block text-xs font-medium text-amber-700 mb-1">Country</label>
                <input type="text" id="modal-donor-country" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly value="India">
              </div>
              <div>
                <label class="block text-xs font-medium text-amber-700 mb-1">Center *</label>
                <select id="modal-donor-center" required class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
                  ${centersList.map(c => `<option value="${c.id}" ${c.id === currentUser.centerId || (currentUser.username === 'admin' && c.id === centersList[0]?.id) ? 'selected' : ''}>${c.name}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>
          
          <div class="flex gap-3 pt-4 border-t border-amber-200 sticky bottom-0 bg-white">
            <button type="button" onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
            <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg">Add Donor</button>
          </div>
        </form>
      `);

      document.getElementById('modal-donor-pincode').addEventListener('input', (e) => {
        lookupPincode(e.target.value, true);
      });

      // Auto-populate WhatsApp from Mobile in modal
      document.getElementById('modal-donor-mobile').addEventListener('input', (e) => {
        const mobile = e.target.value.trim();
        const whatsappField = document.getElementById('modal-donor-whatsapp');
        
        if (mobile && !whatsappField.dataset.manuallyEdited) {
          whatsappField.value = mobile;
          whatsappField.classList.remove('border-amber-200');
          whatsappField.classList.add('bg-amber-100', 'border-amber-400');
          whatsappField.setAttribute('data-auto-filled', 'true');
        }
      });

      document.getElementById('modal-donor-whatsapp').addEventListener('focus', (e) => {
        e.target.classList.remove('bg-amber-50', 'bg-amber-100', 'border-amber-400');
        e.target.classList.add('border-amber-200');
        e.target.dataset.manuallyEdited = 'true';
      });

      document.getElementById('modal-donor-whatsapp').addEventListener('input', (e) => {
        e.target.dataset.manuallyEdited = 'true';
      });

      document.getElementById('modal-donor-whatsapp').addEventListener('blur', (e) => {
        if (!e.target.value.trim()) {
          e.target.dataset.manuallyEdited = 'false';
          const mobile = document.getElementById('modal-donor-mobile').value.trim();
          if (mobile) {
            e.target.value = mobile;
            e.target.classList.add('bg-amber-100', 'border-amber-400');
            e.target.classList.remove('bg-amber-50', 'border-amber-200');
            e.target.removeAttribute('data-auto-filled');
          }
        }
      });

      document.getElementById('add-donor-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const result = await window.dataSdk.create({
          type: 'donor',
          name: document.getElementById('modal-donor-name').value.trim(),
          spiritualName: document.getElementById('modal-donor-spiritual-name').value.trim(),
          indianPassport: document.getElementById('modal-donor-indian-passport').checked,
          pan: document.getElementById('modal-donor-pan').value.trim().toUpperCase(),
          mobile: document.getElementById('modal-donor-mobile').value.trim(),
          whatsapp: document.getElementById('modal-donor-whatsapp').value.trim(),
          email: document.getElementById('modal-donor-email').value.trim(),
          flat: document.getElementById('modal-donor-flat').value.trim(),
          road: document.getElementById('modal-donor-road').value.trim(),
          po: document.getElementById('modal-donor-po').value.trim(),
          area: document.getElementById('modal-donor-area').value.trim(),
          pincode: document.getElementById('modal-donor-pincode').value.trim(),
          district: document.getElementById('modal-donor-district').value.trim(),
          state: document.getElementById('modal-donor-state').value.trim(),
          country: document.getElementById('modal-donor-country').value.trim(),
          centerId: document.getElementById('modal-donor-center').value,
          createdBy: currentUser.username,
          createdAt: new Date().toISOString()
        });

        if (result.isOk) {
          hideModal();
          showToast('Donor added successfully');
        } else {
          showToast('Failed to add donor', 'error');
        }
      });
    }

    function showDonorDetailsModal(donorId) {
      const donor = getDonors().find(d => d.__backendId === donorId);
      if (!donor) {
        showToast('Donor not found', 'error');
        return;
      }

      const bookings = getBookings().filter(b => b.donorId === donorId);
      const totalAmount = bookings.reduce((sum, b) => {
        const items = b.items ? JSON.parse(b.items) : [];
        return sum + items.reduce((s, item) => s + (item.amount * (item.quantity || 1)), 0);
      }, 0);

      showModal(`
        <h3 class="font-display text-2xl font-semibold text-amber-900 mb-6">Donor Profile</h3>
        
        <div class="grid lg:grid-cols-2 gap-6 max-h-[80vh] overflow-y-auto pr-2">
          <!-- Contact Information -->
          <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
            <h4 class="font-semibold text-amber-900 mb-4 flex items-center gap-2">
              <span class="text-lg">üë§</span> Personal Details
            </h4>
            <div class="space-y-3">
              <div>
                <p class="text-xs text-amber-600 font-medium">Legal Name</p>
                <p class="text-sm font-semibold text-amber-900">${donor.name}</p>
              </div>
              <div>
                <p class="text-xs text-amber-600 font-medium">üì± Mobile Number</p>
                <p class="text-sm font-semibold text-amber-900">${donor.mobile}</p>
              </div>
              <div>
                <p class="text-xs text-amber-600 font-medium">üí¨ WhatsApp Number</p>
                <p class="text-sm font-semibold text-amber-900">${donor.whatsapp || '-'}</p>
              </div>
              <div>
                <p class="text-xs text-amber-600 font-medium">‚úâÔ∏è Email</p>
                <p class="text-sm font-semibold text-amber-900">${donor.email || '-'}</p>
              </div>
            </div>
          </div>

          <!-- Address Information -->
          <div class="bg-green-50 rounded-lg p-4 border border-green-200">
            <h4 class="font-semibold text-green-900 mb-4 flex items-center gap-2">
              <span class="text-lg">üìç</span> Address
            </h4>
            <div class="space-y-2 text-sm">
              ${donor.flat ? `<p><span class="font-medium text-green-700">Flat:</span> ${donor.flat}</p>` : ''}
              ${donor.road ? `<p><span class="font-medium text-green-700">Road:</span> ${donor.road}</p>` : ''}
              ${donor.po ? `<p><span class="font-medium text-green-700">Post Office:</span> ${donor.po}</p>` : ''}
              ${donor.area ? `<p><span class="font-medium text-green-700">Area:</span> ${donor.area}</p>` : ''}
              ${donor.pincode ? `<p><span class="font-medium text-green-700">Pincode:</span> ${donor.pincode}</p>` : ''}
              ${donor.district ? `<p><span class="font-medium text-green-700">District:</span> ${donor.district}</p>` : ''}
              ${donor.state ? `<p><span class="font-medium text-green-700">State:</span> ${donor.state}</p>` : ''}
              ${donor.country ? `<p><span class="font-medium text-green-700">Country:</span> ${donor.country}</p>` : ''}
              ${!donor.flat && !donor.road && !donor.po && !donor.area && !donor.pincode ? '<p class="text-green-600 italic">No address on file</p>' : ''}
            </div>
          </div>

          <!-- Donation Statistics -->
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <h4 class="font-semibold text-blue-900 mb-4 flex items-center gap-2">
              <span class="text-lg">üí∞</span> Donation Summary
            </h4>
            <div class="space-y-3">
              <div>
                <p class="text-xs text-blue-600 font-medium">Total Bookings</p>
                <p class="text-2xl font-bold text-blue-900">${bookings.length}</p>
              </div>
              <div>
                <p class="text-xs text-blue-600 font-medium">Total Amount Donated</p>
                <p class="text-2xl font-bold text-blue-900">‚Çπ${totalAmount.toLocaleString()}</p>
              </div>
              <div>
                <p class="text-xs text-blue-600 font-medium">Average Donation</p>
                <p class="text-lg font-semibold text-blue-900">‚Çπ${bookings.length > 0 ? Math.round(totalAmount / bookings.length).toLocaleString() : '0'}</p>
              </div>
            </div>
          </div>

          <!-- Account Information -->
          <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
            <h4 class="font-semibold text-purple-900 mb-4 flex items-center gap-2">
              <span class="text-lg">‚ÑπÔ∏è</span> Account Details
            </h4>
            <div class="space-y-3">
              <div>
                <p class="text-xs text-purple-600 font-medium">Donor ID</p>
                <p class="text-sm font-mono text-purple-900 break-all">${donor.__backendId}</p>
              </div>
              <div>
                <p class="text-xs text-purple-600 font-medium">Registered On</p>
                <p class="text-sm text-purple-900">${new Date(donor.createdAt).toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' })}</p>
              </div>
              <div>
                <p class="text-xs text-purple-600 font-medium">Last Updated</p>
                <p class="text-sm text-purple-900">${donor.updatedAt ? new Date(donor.updatedAt).toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' }) : 'Never'}</p>
              </div>
            </div>
          </div>

          <!-- Recent Bookings -->
          <div class="lg:col-span-2 bg-yellow-50 rounded-lg p-4 border border-yellow-200">
            <h4 class="font-semibold text-yellow-900 mb-4 flex items-center gap-2">
              <span class="text-lg">üìã</span> Recent Bookings (Last 5)
            </h4>
            ${bookings.slice(-5).reverse().length > 0 ? `
              <div class="space-y-2">
                ${bookings.slice(-5).reverse().map(b => {
                  const items = b.items ? JSON.parse(b.items) : [];
                  const bookingTotal = items.reduce((s, item) => s + (item.amount * (item.quantity || 1)), 0);
                  return `
                    <div class="flex justify-between items-center text-sm border-b border-yellow-200 pb-2">
                      <div>
                        <p class="text-yellow-900 font-medium">${new Date(b.bookingDate).toLocaleDateString('en-GB')}</p>
                        <p class="text-xs text-yellow-700">${items.map(i => i.name).join(', ')}</p>
                      </div>
                      <div class="text-right">
                        <p class="text-yellow-900 font-bold">‚Çπ${bookingTotal.toLocaleString()}</p>
                        <p class="text-xs text-yellow-600">${b.paymentStatus || 'pending'}</p>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `<p class="text-yellow-600 italic">No bookings yet</p>`}
          </div>
        </div>

        <div class="flex gap-3 mt-6 pt-4 border-t border-amber-200">
          <button onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Close</button>
          <button onclick="showEditDonorModal('${donorId}')" class="flex-1 btn-primary text-white py-2 rounded-lg">Edit Details</button>
        </div>
      `);
    }

    function showEditDonorModal(donorId) {
      const donor = getDonors().find(d => d.__backendId === donorId);
      if (!donor) {
        showToast('Donor not found', 'error');
        return;
      }

      hideModal();
      showModal(`
        <h3 class="font-display text-xl font-semibold text-amber-900 mb-4">Edit Donor</h3>
        <form id="edit-donor-form" class="space-y-3 max-h-[80vh] overflow-y-auto pr-2">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Legal Name *</label>
            <input type="text" id="edit-modal-donor-name" value="${donor.name || ''}" required class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Full name (First and Last)">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Spiritual Name (Optional)</label>
            <input type="text" id="edit-modal-donor-spiritual-name" value="${donor.spiritualName || ''}" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Initiated name if applicable">
          </div>
          <div class="flex items-center gap-2 py-2">
            <input type="checkbox" id="edit-modal-donor-indian-passport" ${donor.indianPassport ? 'checked' : ''} class="w-4 h-4 text-amber-600 border-amber-300 rounded focus:ring-amber-500">
            <label for="edit-modal-donor-indian-passport" class="text-sm font-medium text-amber-700">Indian Passport Holder</label>
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">PAN Number</label>
            <input type="text" id="edit-modal-donor-pan" value="${donor.pan || ''}" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none uppercase" placeholder="ABCDE1234F" maxlength="10">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Mobile *</label>
            <input type="tel" id="edit-modal-donor-mobile" value="${donor.mobile || ''}" required class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">WhatsApp</label>
            <input type="tel" id="edit-modal-donor-whatsapp" value="${donor.whatsapp || ''}" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Email</label>
            <input type="email" id="edit-modal-donor-email" value="${donor.email || ''}" class="w-full px-3 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          
          <div class="border-t border-amber-200 pt-3 mt-3">
            <p class="text-xs font-semibold text-amber-800 mb-2">üìç Address Details</p>
            
            <div>
              <label class="block text-xs font-medium text-amber-700 mb-1">Flat / Door / Building</label>
              <input type="text" id="edit-modal-donor-flat" value="${donor.flat || ''}" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            
            <div class="mt-2">
              <label class="block text-xs font-medium text-amber-700 mb-1">Road / Street / Block / Sector</label>
              <input type="text" id="edit-modal-donor-road" value="${donor.road || ''}" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            
            <div class="mt-2">
              <label class="block text-xs font-medium text-amber-700 mb-1">Post Office</label>
              <input type="text" id="edit-modal-donor-po" value="${donor.po || ''}" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            
            <div class="mt-2">
              <label class="block text-xs font-medium text-amber-700 mb-1">Area / Locality</label>
              <input type="text" id="edit-modal-donor-area" value="${donor.area || ''}" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
            </div>
            
            <div class="mt-2">
              <label class="block text-xs font-medium text-amber-700 mb-1">Pincode *</label>
              <input type="text" id="edit-modal-donor-pincode" value="${donor.pincode || ''}" maxlength="6" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
              <div id="edit-modal-pincode-status" class="text-xs mt-1 text-amber-600"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <label class="block text-xs font-medium text-amber-700 mb-1">District</label>
                <input type="text" id="edit-modal-donor-district" value="${donor.district || ''}" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly>
              </div>
              <div>
                <label class="block text-xs font-medium text-amber-700 mb-1">State</label>
                <input type="text" id="edit-modal-donor-state" value="${donor.state || ''}" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div>
                <label class="block text-xs font-medium text-amber-700 mb-1">Country</label>
                <input type="text" id="edit-modal-donor-country" value="${donor.country || 'India'}" class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none bg-amber-50" readonly>
              </div>
              <div>
                <label class="block text-xs font-medium text-amber-700 mb-1">Center *</label>
                <select id="edit-modal-donor-center" required class="w-full px-3 py-2 text-sm border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
                  ${centersList.map(c => `<option value="${c.id}" ${c.id === donor.centerId ? 'selected' : ''}>${c.name}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>
          
          <div class="flex gap-3 pt-4 border-t border-amber-200 sticky bottom-0 bg-white">
            <button type="button" onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
            <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg">Save Changes</button>
          </div>
        </form>
      `);

      document.getElementById('edit-modal-donor-pincode').addEventListener('input', (e) => {
        const prefix = 'edit-modal-';
        const statusDiv = document.getElementById(prefix + 'pincode-status');
        const districtField = document.getElementById(prefix + 'donor-district');
        const stateField = document.getElementById(prefix + 'donor-state');
        const countryField = document.getElementById(prefix + 'donor-country');
        
        const pincode = e.target.value;
        if (!pincode || pincode.length !== 6) {
          districtField.value = '';
          stateField.value = '';
          countryField.value = 'India';
          districtField.removeAttribute('readonly');
          stateField.removeAttribute('readonly');
          statusDiv.textContent = '';
          return;
        }

        const data = pincodeDatabase[pincode];
        
        if (data) {
          districtField.value = data.district;
          stateField.value = data.state;
          countryField.value = data.country;
          districtField.setAttribute('readonly', true);
          stateField.setAttribute('readonly', true);
          statusDiv.textContent = 'ÔøΩÔøΩÔøΩ Valid pincode - details auto-filled';
          statusDiv.classList.remove('text-red-600');
          statusDiv.classList.add('text-green-600');
        } else {
          districtField.value = '';
          stateField.value = '';
          countryField.value = 'India';
          districtField.removeAttribute('readonly');
          stateField.removeAttribute('readonly');
          statusDiv.textContent = '‚ö† Pincode not found - enter details manually';
          statusDiv.classList.remove('text-green-600');
          statusDiv.classList.add('text-amber-600');
        }
      });

      document.getElementById('edit-donor-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const updatedDonor = {
          ...donor,
          name: document.getElementById('edit-modal-donor-name').value.trim(),
          spiritualName: document.getElementById('edit-modal-donor-spiritual-name').value.trim(),
          indianPassport: document.getElementById('edit-modal-donor-indian-passport').checked,
          pan: document.getElementById('edit-modal-donor-pan').value.trim().toUpperCase(),
          mobile: document.getElementById('edit-modal-donor-mobile').value.trim(),
          whatsapp: document.getElementById('edit-modal-donor-whatsapp').value.trim(),
          email: document.getElementById('edit-modal-donor-email').value.trim(),
          flat: document.getElementById('edit-modal-donor-flat').value.trim(),
          road: document.getElementById('edit-modal-donor-road').value.trim(),
          po: document.getElementById('edit-modal-donor-po').value.trim(),
          area: document.getElementById('edit-modal-donor-area').value.trim(),
          pincode: document.getElementById('edit-modal-donor-pincode').value.trim(),
          district: document.getElementById('edit-modal-donor-district').value.trim(),
          state: document.getElementById('edit-modal-donor-state').value.trim(),
          country: document.getElementById('edit-modal-donor-country').value.trim(),
          centerId: document.getElementById('edit-modal-donor-center').value,
          updatedAt: new Date().toISOString()
        };

        const result = await window.dataSdk.update(updatedDonor);

        if (result.isOk) {
          hideModal();
          showToast('Donor updated successfully');
        } else {
          showToast('Failed to update donor', 'error');
        }
      });
    }

    function showAddSevaModal() {
      showModal(`
        <h3 class="font-display text-xl font-semibold text-amber-900 mb-4">Add New Seva</h3>
        <form id="add-seva-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Seva Name *</label>
            <input type="text" id="new-seva-name" required class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Description</label>
            <input type="text" id="new-seva-desc" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Amount (Rs.) *</label>
            <input type="number" id="new-seva-amount" required min="1" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
            <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg">Add Seva</button>
          </div>
        </form>
      `);

      document.getElementById('add-seva-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newSeva = {
          id: 'seva_' + Date.now(),
          name: document.getElementById('new-seva-name').value.trim(),
          description: document.getElementById('new-seva-desc').value.trim(),
          amount: parseInt(document.getElementById('new-seva-amount').value),
          shortcut: true // New sevas show in shortcuts by default
        };
        sevasList.push(newSeva);
        saveSevas();
        renderSevasGrid();
        renderSlidingSevaList();
        renderSelectedSevasList();
        renderQuickSevaGrid();
        populateSevaFilter();
        updateDashboard();
        hideModal();
        showToast('Seva added successfully');
      });
    }

    function showEditSevaModal(sevaId) {
      const seva = sevasList.find(s => s.id === sevaId);
      if (!seva) return;

      showModal(`
        <h3 class="font-display text-xl font-semibold text-amber-900 mb-4">Edit Seva</h3>
        <form id="edit-seva-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Seva Name *</label>
            <input type="text" id="edit-seva-name" value="${seva.name}" required class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Description</label>
            <input type="text" id="edit-seva-desc" value="${seva.description}" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Amount (Rs.) *</label>
            <input type="number" id="edit-seva-amount" value="${seva.amount}" required min="1" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none">
          </div>
          <div class="flex gap-3 pt-2">
            <button type="button" onclick="hideModal()" class="flex-1 px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50">Cancel</button>
            <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg">Update</button>
          </div>
        </form>
      `);

      document.getElementById('edit-seva-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const idx = sevasList.findIndex(s => s.id === sevaId);
        if (idx >= 0) {
          sevasList[idx] = {
            ...sevasList[idx],
            name: document.getElementById('edit-seva-name').value.trim(),
            description: document.getElementById('edit-seva-desc').value.trim(),
            amount: parseInt(document.getElementById('edit-seva-amount').value)
          };
          saveSevas();
          renderSevasGrid();
          renderSlidingSevaList();
          renderQuickSevaGrid();
          hideModal();
          showToast('Seva updated');
        }
      });
    }

    // Booking Functions
    async function saveBooking() {
      const donorId = document.getElementById('donor-id').value;
      const name = document.getElementById('donor-name').value.trim();
      const spiritualName = document.getElementById('donor-spiritual-name').value.trim();
      const indianPassport = document.getElementById('donor-indian-passport').checked;
      const pan = document.getElementById('donor-pan').value.trim().toUpperCase();
      const mobile = document.getElementById('donor-mobile').value.trim();

      if (!name || !mobile) {
        showToast('Please fill donor name and mobile', 'error');
        return;
      }

      if (cart.length === 0) {
        showToast('Please select at least one seva', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Maximum data limit reached. Please contact administrator.', 'error');
        return;
      }

      const btn = document.getElementById('save-booking-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        let finalDonorId = donorId;
        let finalDonor = null;

        if (!donorId) {
          const donorResult = await window.dataSdk.create({
            type: 'donor',
            name,
            spiritualName,
            indianPassport,
            pan,
            mobile,
            whatsapp: document.getElementById('donor-whatsapp').value.trim(),
            email: document.getElementById('donor-email').value.trim(),
            flat: document.getElementById('donor-flat').value.trim(),
            road: document.getElementById('donor-road').value.trim(),
            po: document.getElementById('donor-po').value.trim(),
            area: document.getElementById('donor-area').value.trim(),
            pincode: document.getElementById('donor-pincode').value.trim(),
            district: document.getElementById('donor-district').value.trim(),
            state: document.getElementById('donor-state').value.trim(),
            country: document.getElementById('donor-country').value.trim(),
            centerId: document.getElementById('donor-center').value,
            createdBy: currentUser.username,
            createdAt: new Date().toISOString()
          });

          if (!donorResult.isOk) {
            showToast('Failed to save donor', 'error');
            return;
          }
          
          await new Promise(r => setTimeout(r, 500));
          finalDonor = getDonors().find(d => d.mobile === mobile);
          if (finalDonor) {
            finalDonorId = finalDonor.__backendId;
          } else {
            showToast('Error: Donor created but could not retrieve ID', 'error');
            return;
          }
        } else {
          finalDonor = getDonors().find(d => d.__backendId === donorId);
        }

        const total = cart.reduce((sum, item) => sum + item.amount, 0);
        // Determine center for booking
        const isSuperadmin = currentUser.username === 'admin';
        const bookingCenterId = isSuperadmin ? 'all_centers' : (currentUser.centerId || 'center_bangalore');
        const collectorCenter = isSuperadmin ? 'all_centers' : currentUser.centerId;
        
        const festivalQR = document.getElementById('booking-festival-qr').checked;
        const bookingResult = await window.dataSdk.create({
          type: 'booking',
          donorId: finalDonorId,
          items: JSON.stringify(cart),
          totalAmount: total,
          paymentStatus: 'pending',
          bookingDate: new Date().toISOString(),
          centerId: bookingCenterId,
          collectedBy: currentUser.username,
          collectedByCenter: collectorCenter,
          festivalQR: festivalQR,
          createdAt: new Date().toISOString()
        });

        if (bookingResult.isOk) {
          showToast('Booking saved successfully!');
          cart = [];
          clearDonorForm();
          renderCart();
          renderSlidingSevaList();
        } else {
          showToast('Failed to save booking', 'error');
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Booking';
      }
    }

    async function openRazorpay() {
      const donorId = document.getElementById('donor-id').value;
      const name = document.getElementById('donor-name').value.trim();
      const mobile = document.getElementById('donor-mobile').value.trim();
      const total = cart.reduce((sum, item) => sum + item.amount, 0);

      if (!name || !mobile) {
        showToast('Please fill donor name and mobile', 'error');
        return;
      }
      if (total === 0) {
        showToast('Please select at least one seva', 'error');
        return;
      }
      if (typeof Razorpay === 'undefined') {
        showToast('Razorpay is loading. Please try again.', 'error');
        return;
      }

      const btn = document.getElementById('razorpay-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Preparing...';

      try {
        let finalDonorId = donorId;
        if (!donorId) {
          const donorResult = await window.dataSdk.create({
            type: 'donor',
            name,
            spiritualName: document.getElementById('donor-spiritual-name').value.trim(),
            indianPassport: document.getElementById('donor-indian-passport').checked,
            pan: document.getElementById('donor-pan').value.trim().toUpperCase(),
            mobile,
            whatsapp: document.getElementById('donor-whatsapp').value.trim(),
            email: document.getElementById('donor-email').value.trim(),
            flat: document.getElementById('donor-flat').value.trim(),
            road: document.getElementById('donor-road').value.trim(),
            po: document.getElementById('donor-po').value.trim(),
            area: document.getElementById('donor-area').value.trim(),
            pincode: document.getElementById('donor-pincode').value.trim(),
            district: document.getElementById('donor-district').value.trim(),
            state: document.getElementById('donor-state').value.trim(),
            country: document.getElementById('donor-country').value.trim(),
            centerId: document.getElementById('donor-center').value,
            createdBy: currentUser.username,
            createdAt: new Date().toISOString()
          });
          if (!donorResult.isOk) {
            showToast('Failed to save donor', 'error');
            return;
          }
          await new Promise(r => setTimeout(r, 400));
          const finalDonor = getDonors().find(d => d.mobile === mobile);
          if (finalDonor) finalDonorId = finalDonor.__backendId;
          else {
            showToast('Donor created but could not get ID', 'error');
            return;
          }
        }

        const isSuperadmin = currentUser.username === 'admin';
        const bookingCenterId = isSuperadmin ? 'all_centers' : (currentUser.centerId || 'center_bangalore');
        const collectorCenter = isSuperadmin ? 'all_centers' : currentUser.centerId;
        const festivalQR = document.getElementById('booking-festival-qr').checked;

        const bookingResult = await window.dataSdk.create({
          type: 'booking',
          donorId: finalDonorId,
          items: JSON.stringify(cart),
          totalAmount: total,
          paymentStatus: 'pending',
          bookingDate: new Date().toISOString(),
          centerId: bookingCenterId,
          collectedBy: currentUser.username,
          collectedByCenter: collectorCenter,
          festivalQR: festivalQR,
          createdAt: new Date().toISOString()
        });

        if (!bookingResult.isOk) {
          showToast(bookingResult.error || 'Failed to create booking', 'error');
          return;
        }

        const bookingId = bookingResult.data.__backendId;
        const amountPaise = Math.round(total * 100);

        const orderResult = await apiClient.call('createRazorpayOrder', {
          amount: amountPaise,
          receipt: bookingId,
          currency: 'INR'
        });

        if (!orderResult.isOk) {
          showToast(orderResult.error || 'Failed to create payment order', 'error');
          return;
        }

        const options = {
          key: orderResult.keyId,
          amount: orderResult.amount,
          order_id: orderResult.orderId,
          name: 'ISKCON Cultural Centre',
          description: 'Seva Donation',
          handler: async function(response) {
            const verifyResult = await apiClient.call('verifyRazorpayPayment', {
              orderId: response.razorpay_order_id,
              paymentId: response.razorpay_payment_id,
              signature: response.razorpay_signature,
              bookingId: bookingId
            });
            if (verifyResult.isOk) {
              showToast('Payment successful! Booking saved.');
              cart.length = 0;
              clearDonorForm();
              renderCart();
              renderSlidingSevaList();
              window.dataSdk.refreshData().then(() => renderAll());
            } else {
              showToast(verifyResult.error || 'Payment verification failed', 'error');
            }
          },
          modal: { ondismiss: function() { btn.disabled = false; btn.textContent = originalText; } }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (e) {
        showToast(e.message || 'Something went wrong', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // Login/Logout
    async function handleLogin(username, password) {
      // Show loading state
      const loginBtn = document.querySelector('#login-form button[type="submit"]');
      const originalBtnText = loginBtn.textContent;
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      
      try {
        const result = await window.authSdk.login(username, password);
        
        if (result.isOk) {
          currentUser = result.user;
          
          // Check if password change is required (first-time superadmin)
          if (result.user.passwordChangeRequired) {
            showPasswordChangeModal();
          }
          
          // Show dashboard immediately (data loads in background)
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
          
          // Set role display
          if (currentUser.role === 'superadmin') {
            document.getElementById('user-role-display').textContent = 'Logged in as Superadmin';
          } else if (currentUser.role === 'donor') {
            document.getElementById('user-role-display').textContent = `Donor: ${currentUser.username}`;
          } else {
            const roleDisplay = `${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)} (${currentUser.username})`;
            document.getElementById('user-role-display').textContent = `Logged in as ${roleDisplay}`;
          }
          
          document.getElementById('login-error').classList.add('hidden');
          updateUIBasedOnPermissions();
          
          // Render with whatever data is available, then update when data loads
          renderAll();
          
          // Wait for data to fully load, then re-render
          window.dataSdk.ensureDataLoaded().then(() => {
            renderAll();
            if (currentUser.role === 'donor') {
              prefillDonorDetails();
            }
          });
        } else {
          document.getElementById('login-error').textContent = result.error || 'Invalid username or password';
          document.getElementById('login-error').classList.remove('hidden');
        }
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = originalBtnText;
      }
    }
    
    // Show password change modal (for first-time superadmin login)
    function showPasswordChangeModal() {
      showModal(`
        <div class="text-center mb-4">
          <div class="w-16 h-16 mx-auto mb-4 bg-amber-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h3 class="font-display text-xl font-semibold text-amber-900 mb-2">Change Default Password</h3>
          <p class="text-amber-700 text-sm mb-4">For security, please change your default password.</p>
        </div>
        <form id="change-password-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Current Password</label>
            <input type="password" id="current-password" required class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Enter current password">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">New Password</label>
            <input type="password" id="new-password-change" required minlength="8" class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Minimum 8 characters">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-1">Confirm New Password</label>
            <input type="password" id="confirm-password-change" required class="w-full px-4 py-2 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Confirm new password">
          </div>
          <div id="password-change-error" class="text-red-600 text-sm hidden"></div>
          <button type="submit" class="w-full btn-primary text-white py-2 rounded-lg font-semibold">Change Password</button>
        </form>
      `);
      
      document.getElementById('change-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password-change').value;
        const confirmPassword = document.getElementById('confirm-password-change').value;
        
        if (newPassword !== confirmPassword) {
          document.getElementById('password-change-error').textContent = 'Passwords do not match';
          document.getElementById('password-change-error').classList.remove('hidden');
          return;
        }
        
        if (newPassword.length < 8) {
          document.getElementById('password-change-error').textContent = 'Password must be at least 8 characters';
          document.getElementById('password-change-error').classList.remove('hidden');
          return;
        }
        
        const result = await window.authSdk.changePassword(currentPassword, newPassword);
        
        if (result.isOk) {
          hideModal();
          showToast('Password changed successfully');
        } else {
          document.getElementById('password-change-error').textContent = result.error || 'Failed to change password';
          document.getElementById('password-change-error').classList.remove('hidden');
        }
      });
    }

    async function handleLogout() {
      // Clear session on backend
      await window.authSdk.logout();
      
      // Clear local state
      currentUser = null;
      
      // Reset UI
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('login-error').classList.add('hidden');
      
      // Clear cart
      cart = [];
      
      showToast('Logged out successfully');
    }

    function renderAll() {
      renderQuickSevaGrid();
      renderSlidingSevaList();
      renderSelectedSevasList();
      renderCart();
      renderDonorsTable();
      renderUsersTable();
      renderSevasGrid();
      renderReportsTable();
      renderPermissionsPage();
      renderDonorLoginsTable();
      renderCentersTable();
      populateSevaFilter();
      populateCollectorFilter();
      populateAllCenterDropdowns();
      updateDashboard();
    }

    // Data Handler
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        
        if (currentUser) {
          renderAll();
        }
      }
    };

    // Initialize
    async function init() {
      const yearEl = document.getElementById('footer-year');
      if (yearEl) yearEl.textContent = new Date().getFullYear();

      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.getElementById('temple-title').textContent = config.temple_name || defaultConfig.temple_name;
            document.getElementById('dashboard-title').textContent = config.temple_name || defaultConfig.temple_name;
            document.getElementById('welcome-text').textContent = config.welcome_message || defaultConfig.welcome_message;
          },
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['temple_name', config.temple_name || defaultConfig.temple_name],
            ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }
      
      // Initialize data SDK
      if (window.dataSdk) {
        await window.dataSdk.init(dataHandler);
      }
      
      // Check for existing session
      const existingSession = sessionManager.getSession();
      if (existingSession && existingSession.sessionId) {
        const validateResult = await window.authSdk.validateSession();
        if (validateResult.isOk) {
          currentUser = validateResult.user;
          
          // Show dashboard immediately (data loads in background)
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
          
          // Set role display
          if (currentUser.role === 'superadmin') {
            document.getElementById('user-role-display').textContent = 'Logged in as Superadmin';
          } else if (currentUser.role === 'donor') {
            document.getElementById('user-role-display').textContent = `Donor: ${currentUser.username}`;
            prefillDonorDetails();
          } else {
            const roleDisplay = `${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)} (${currentUser.username})`;
            document.getElementById('user-role-display').textContent = `Logged in as ${roleDisplay}`;
          }
          
          updateUIBasedOnPermissions();
          
          // Load data in background and render when ready
          window.dataSdk.ensureDataLoaded().then(() => {
            renderAll();
          });
          
          setupEventListeners();
          return;
        } else {
          sessionManager.clearSession();
        }
      }
      
      // Set up event listeners
      setupEventListeners();
    }
    
    // Event Listeners Setup Function (extracted to be called from multiple places)
    function setupEventListeners() {
      // Prevent duplicate listeners
      if (window._eventListenersSetup) return;
      window._eventListenersSetup = true;
      
      document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        handleLogin(username, password);
      });

      document.getElementById('logout-btn').addEventListener('click', handleLogout);

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchTab(btn.dataset.tab);
        });
      });

      document.getElementById('search-donor-btn').addEventListener('click', searchDonor);
      document.getElementById('search-mobile').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchDonor();
      });
      document.getElementById('search-mobile').addEventListener('input', showSearchDropdown);
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('search-dropdown');
        const searchInput = document.getElementById('search-mobile');
        if (!e.target.closest('#search-mobile') && !e.target.closest('#search-dropdown')) {
          dropdown.classList.add('hidden');
        }
      });

      document.getElementById('save-booking-btn').addEventListener('click', saveBooking);
      document.getElementById('razorpay-btn').addEventListener('click', openRazorpay);

      document.getElementById('add-user-btn').addEventListener('click', showAddUserModal);
      document.getElementById('add-donor-btn').addEventListener('click', showAddDonorModal);
      document.getElementById('add-seva-btn').addEventListener('click', showAddSevaModal);

      // Download dropdown toggles
      document.getElementById('download-reports-dropdown-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('download-reports-dropdown').classList.toggle('hidden');
        document.getElementById('download-donors-dropdown').classList.add('hidden');
      });
      
      document.getElementById('download-donors-dropdown-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('download-donors-dropdown').classList.toggle('hidden');
        document.getElementById('download-reports-dropdown').classList.add('hidden');
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
        document.getElementById('download-reports-dropdown').classList.add('hidden');
        document.getElementById('download-donors-dropdown').classList.add('hidden');
      });
      
      // Reports download buttons
      document.getElementById('download-reports-excel').addEventListener('click', () => {
        downloadReportsExcel();
        document.getElementById('download-reports-dropdown').classList.add('hidden');
      });
      document.getElementById('download-reports-csv').addEventListener('click', () => {
        downloadReportsCSV();
        document.getElementById('download-reports-dropdown').classList.add('hidden');
      });
      document.getElementById('download-reports-xml').addEventListener('click', () => {
        downloadReportsXML();
        document.getElementById('download-reports-dropdown').classList.add('hidden');
      });
      document.getElementById('download-reports-json').addEventListener('click', () => {
        downloadReportsJSON();
        document.getElementById('download-reports-dropdown').classList.add('hidden');
      });
      document.getElementById('download-reports-pdf').addEventListener('click', () => {
        downloadReportsPDF();
        document.getElementById('download-reports-dropdown').classList.add('hidden');
      });
      
      // Donors download buttons
      document.getElementById('download-donors-excel').addEventListener('click', () => {
        downloadDonorsExcel();
        document.getElementById('download-donors-dropdown').classList.add('hidden');
      });
      document.getElementById('download-donors-csv').addEventListener('click', () => {
        downloadDonorsCSV();
        document.getElementById('download-donors-dropdown').classList.add('hidden');
      });
      document.getElementById('download-donors-xml').addEventListener('click', () => {
        downloadDonorsXML();
        document.getElementById('download-donors-dropdown').classList.add('hidden');
      });
      document.getElementById('download-donors-json').addEventListener('click', () => {
        downloadDonorsJSON();
        document.getElementById('download-donors-dropdown').classList.add('hidden');
      });

      document.getElementById('users-center-filter').addEventListener('change', renderUsersTable);

      document.getElementById('modal-backdrop').addEventListener('click', hideModal);

      document.getElementById('filter-seva').addEventListener('change', updateDashboard);
      document.getElementById('filter-date').addEventListener('change', updateDashboard);
      document.getElementById('filter-start-date').addEventListener('change', updateDashboard);
      document.getElementById('filter-end-date').addEventListener('change', updateDashboard);

      document.getElementById('report-status-filter').addEventListener('change', renderReportsTable);
      document.getElementById('report-collector-filter').addEventListener('change', renderReportsTable);
      document.getElementById('report-date-filter').addEventListener('change', renderReportsTable);
      document.getElementById('report-start-date').addEventListener('change', renderReportsTable);
      document.getElementById('report-end-date').addEventListener('change', renderReportsTable);
      
      // Donor logins filters
      document.getElementById('donor-logins-center-filter').addEventListener('change', renderDonorLoginsTable);
      
      // Center management
      document.getElementById('add-center-btn').addEventListener('click', openAddCenterModal);
      
      // Donor logins search with dropdown
      const donorLoginsSearch = document.getElementById('donor-logins-search');
      const donorLoginsDropdown = document.getElementById('donor-logins-search-dropdown');
      
      donorLoginsSearch.addEventListener('input', () => {
        const searchTerm = donorLoginsSearch.value.trim().toLowerCase();
        
        if (searchTerm.length < 1) {
          donorLoginsDropdown.classList.add('hidden');
          renderDonorLoginsTable();
          return;
        }
        
        // Get filtered donors for dropdown
        let donors = getDonors();
        const centerFilter = document.getElementById('donor-logins-center-filter');
        if (centerFilter && centerFilter.value) {
          donors = donors.filter(d => d.centerId === centerFilter.value);
        }
        
        const matchingDonors = donors.filter(d => 
          (d.name && d.name.toLowerCase().includes(searchTerm)) ||
          (d.spiritualName && d.spiritualName.toLowerCase().includes(searchTerm)) ||
          (d.mobile && d.mobile.includes(searchTerm))
        ).slice(0, 8); // Limit to 8 results
        
        if (matchingDonors.length === 0) {
          donorLoginsDropdown.innerHTML = '<div class="px-4 py-3 text-amber-600 text-sm">No donors found</div>';
        } else {
          donorLoginsDropdown.innerHTML = matchingDonors.map(d => `
            <div class="donor-search-item px-4 py-3 hover:bg-amber-50 cursor-pointer border-b border-amber-100 last:border-0" data-name="${d.name}">
              <div class="font-medium text-amber-900">${d.name}</div>
              <div class="text-xs text-amber-600">${d.spiritualName ? d.spiritualName + ' ‚Ä¢ ' : ''}${d.mobile}</div>
            </div>
          `).join('');
          
          // Add click handlers
          donorLoginsDropdown.querySelectorAll('.donor-search-item').forEach(item => {
            item.addEventListener('click', () => {
              donorLoginsSearch.value = item.dataset.name;
              donorLoginsDropdown.classList.add('hidden');
              renderDonorLoginsTable();
            });
          });
        }
        
        donorLoginsDropdown.classList.remove('hidden');
        renderDonorLoginsTable();
      });
      
      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!donorLoginsSearch.contains(e.target) && !donorLoginsDropdown.contains(e.target)) {
          donorLoginsDropdown.classList.add('hidden');
        }
      });
      
      // Show dropdown on focus if there's text
      donorLoginsSearch.addEventListener('focus', () => {
        if (donorLoginsSearch.value.trim().length >= 1) {
          donorLoginsSearch.dispatchEvent(new Event('input'));
        }
      });
      
      // Clear search button functionality (press Escape)
      donorLoginsSearch.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          donorLoginsSearch.value = '';
          donorLoginsDropdown.classList.add('hidden');
          renderDonorLoginsTable();
        }
      });

      document.getElementById('browse-sevas-btn').addEventListener('click', () => {
        document.getElementById('seva-panel-backdrop').classList.remove('hidden');
        document.getElementById('seva-slide-panel').classList.remove('hidden');
        renderSlidingSevaList();
      });

      document.getElementById('close-seva-panel-btn').addEventListener('click', () => {
        document.getElementById('seva-panel-backdrop').classList.add('hidden');
        document.getElementById('seva-slide-panel').classList.add('hidden');
      });

      document.getElementById('seva-panel-backdrop').addEventListener('click', () => {
        document.getElementById('seva-panel-backdrop').classList.add('hidden');
        document.getElementById('seva-slide-panel').classList.add('hidden');
      });

      document.getElementById('finish-seva-selection-btn').addEventListener('click', () => {
        document.getElementById('seva-panel-backdrop').classList.add('hidden');
        document.getElementById('seva-slide-panel').classList.add('hidden');
      });

      document.getElementById('donor-pincode').addEventListener('input', (e) => {
        lookupPincode(e.target.value);
      });

      // Auto-populate WhatsApp from Mobile
      document.getElementById('donor-mobile').addEventListener('input', (e) => {
        const mobile = e.target.value.trim();
        const whatsappField = document.getElementById('donor-whatsapp');
        
        if (mobile && !whatsappField.dataset.manuallyEdited) {
          whatsappField.value = mobile;
          whatsappField.classList.add('bg-amber-50');
          whatsappField.setAttribute('data-auto-filled', 'true');
        }
      });

      document.getElementById('donor-whatsapp').addEventListener('focus', (e) => {
        // User is focusing on the field - allow editing
        e.target.classList.remove('bg-amber-50');
        e.target.dataset.manuallyEdited = 'true';
      });

      document.getElementById('donor-whatsapp').addEventListener('input', (e) => {
        // Mark that user has manually edited this field
        e.target.dataset.manuallyEdited = 'true';
      });

      document.getElementById('donor-whatsapp').addEventListener('blur', (e) => {
        // If field is empty after blur, re-enable auto-populate
        if (!e.target.value.trim()) {
          e.target.dataset.manuallyEdited = 'false';
          const mobile = document.getElementById('donor-mobile').value.trim();
          if (mobile) {
            e.target.value = mobile;
            e.target.classList.add('bg-amber-50');
            e.target.removeAttribute('data-auto-filled');
          }
        }
      });
    }

    init();
  </script>
</body>
</html>
